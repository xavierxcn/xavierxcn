{% extends "base.html" %}

{% block title %}装修预算助手 - {{ site.title }}{% endblock %}

{% block description %}规划装修预算，支持清包、半包、全包、全案四种装修方式，可导出 Excel{% endblock %}

{% block head %}
<style>
    :root {
        --budget-primary: #059669;
        --budget-primary-light: #10b981;
        --budget-primary-dark: #047857;
        --budget-accent: #f59e0b;
        --budget-surface: #ffffff;
        --budget-bg: #f8fafc;
        --budget-text: #1e293b;
        --budget-text-secondary: #64748b;
        --budget-border: #e2e8f0;
        --budget-success: #22c55e;
        --budget-warning: #f59e0b;
        --budget-error: #ef4444;
        --budget-info: #3b82f6;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --budget-surface: #1e293b;
            --budget-bg: #0f172a;
            --budget-text: #f1f5f9;
            --budget-text-secondary: #94a3b8;
            --budget-border: #334155;
        }
    }

    html, body {
        height: 100%;
    }

    body {
        display: flex;
        flex-direction: column;
    }

    .main-content {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
        padding: 0 !important;
        max-width: none !important;
        margin: 0 !important;
        animation: none !important;
    }

    .budget-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px 24px;
        gap: 20px;
        overflow: hidden;
        background: var(--budget-bg);
    }

    /* Header */
    .budget-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }

    .budget-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--budget-text);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .budget-title-icon {
        font-size: 24px;
        font-variant-emoji: text;
    }

    .header-actions {
        display: flex;
        gap: 12px;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
    }

    .btn-primary {
        background: var(--budget-primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--budget-primary-dark);
    }

    .btn-secondary {
        background: var(--budget-surface);
        color: var(--budget-text-secondary);
        border: 1px solid var(--budget-border);
    }

    .btn-secondary:hover {
        background: var(--budget-bg);
        color: var(--budget-text);
    }

    .btn svg {
        width: 16px;
        height: 16px;
    }

    /* Main layout */
    .budget-main {
        flex: 1;
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
        min-height: 0;
        overflow: hidden;
    }

    /* Settings Panel */
    .settings-panel {
        background: var(--budget-surface);
        border-radius: 12px;
        border: 1px solid var(--budget-border);
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .settings-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .settings-section-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--budget-text);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--budget-primary);
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-group label {
        font-size: 13px;
        font-weight: 500;
        color: var(--budget-text-secondary);
    }

    .form-group input,
    .form-group select {
        padding: 10px 12px;
        border: 1px solid var(--budget-border);
        border-radius: 8px;
        font-size: 14px;
        background: var(--budget-surface);
        color: var(--budget-text);
        transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--budget-primary);
    }

    .form-group input[type="number"] {
        -moz-appearance: textfield;
    }

    .form-group input[type="number"]::-webkit-inner-spin-button,
    .form-group input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
    }

    .input-with-unit {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .input-with-unit input {
        flex: 1;
    }

    .input-unit {
        font-size: 13px;
        color: var(--budget-text-secondary);
        white-space: nowrap;
    }

    /* Mode selector */
    .mode-selector {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }

    .mode-option {
        padding: 12px;
        border: 2px solid var(--budget-border);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        background: var(--budget-surface);
    }

    .mode-option:hover {
        border-color: var(--budget-primary-light);
    }

    .mode-option.active {
        border-color: var(--budget-primary);
        background: linear-gradient(135deg, rgba(5, 150, 105, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
    }

    .mode-option-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--budget-text);
        margin-bottom: 4px;
    }

    .mode-option-desc {
        font-size: 11px;
        color: var(--budget-text-secondary);
        line-height: 1.4;
    }

    /* Summary Card */
    .summary-card {
        background: linear-gradient(135deg, var(--budget-primary) 0%, var(--budget-primary-dark) 100%);
        border-radius: 12px;
        padding: 20px;
        color: white;
    }

    .summary-total-label {
        font-size: 13px;
        opacity: 0.9;
        margin-bottom: 4px;
    }

    .summary-total-amount {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: -0.5px;
    }

    .summary-breakdown {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
    }

    .summary-row-label {
        opacity: 0.85;
    }

    .summary-row-value {
        font-weight: 600;
    }

    /* Budget Panel */
    .budget-panel {
        background: var(--budget-surface);
        border-radius: 12px;
        border: 1px solid var(--budget-border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .budget-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--budget-border);
        flex-shrink: 0;
    }

    .budget-panel-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--budget-text);
    }

    .budget-panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px 20px;
    }

    /* Category sections */
    .budget-category {
        margin-bottom: 24px;
    }

    .budget-category:last-child {
        margin-bottom: 0;
    }

    .category-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: var(--budget-bg);
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
        margin-bottom: 12px;
    }

    .category-header:hover {
        background: var(--budget-border);
    }

    .category-title {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .category-icon {
        font-size: 18px;
        font-variant-emoji: text;
    }

    .category-name {
        font-size: 15px;
        font-weight: 600;
        color: var(--budget-text);
    }

    .category-subtotal {
        font-size: 14px;
        font-weight: 600;
        color: var(--budget-primary);
    }

    .category-chevron {
        width: 20px;
        height: 20px;
        color: var(--budget-text-secondary);
        transition: transform 0.2s;
    }

    .category-header.collapsed .category-chevron {
        transform: rotate(-90deg);
    }

    .category-items {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-left: 16px;
    }

    .category-items.collapsed {
        display: none;
    }

    /* Budget item row */
    .budget-item {
        display: grid;
        grid-template-columns: 140px 80px 100px 1fr 100px;
        gap: 10px;
        align-items: center;
        padding: 10px 12px;
        background: var(--budget-bg);
        border-radius: 8px;
        transition: background 0.2s;
    }

    .budget-item:hover {
        background: var(--budget-border);
    }

    .item-name {
        font-size: 14px;
        color: var(--budget-text);
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .item-input {
        padding: 8px 10px;
        border: 1px solid var(--budget-border);
        border-radius: 6px;
        font-size: 13px;
        text-align: right;
        background: var(--budget-surface);
        color: var(--budget-text);
    }

    .item-input:focus {
        outline: none;
        border-color: var(--budget-primary);
    }

    .item-input.item-note {
        text-align: left;
        font-size: 12px;
    }

    .item-input::placeholder {
        color: var(--budget-text-secondary);
        opacity: 0.6;
    }

    .item-subtotal {
        font-size: 14px;
        font-weight: 600;
        color: var(--budget-text);
        text-align: right;
    }

    /* Column headers */
    .items-header {
        display: grid;
        grid-template-columns: 140px 80px 100px 1fr 100px;
        gap: 10px;
        padding: 0 12px 8px;
        font-size: 12px;
        font-weight: 600;
        color: var(--budget-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .items-header span:nth-child(2),
    .items-header span:nth-child(3),
    .items-header span:nth-child(5) {
        text-align: right;
    }

    /* Simple mode headers and items */
    .items-header-simple {
        grid-template-columns: 140px 1fr 100px 40px;
    }

    .items-header-simple span:nth-child(3) {
        text-align: right;
    }

    .budget-item-simple {
        grid-template-columns: 140px 1fr 100px 40px;
    }

    .item-note-wide {
        text-align: left;
    }

    .item-subtotal-wrapper {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
    }

    .item-action-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
    }

    /* Add item button */
    .add-item-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        width: 100%;
        padding: 10px 12px;
        margin-top: 8px;
        background: transparent;
        border: 2px dashed var(--budget-border);
        border-radius: 8px;
        color: var(--budget-text-secondary);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
    }

    .add-item-btn:hover {
        border-color: var(--budget-primary);
        color: var(--budget-primary);
        background: rgba(5, 150, 105, 0.05);
    }

    .add-item-btn svg {
        width: 16px;
        height: 16px;
    }

    /* Delete item button */
    .delete-item-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        padding: 0;
        background: transparent;
        border: none;
        border-radius: 6px;
        color: var(--budget-text-secondary);
        cursor: pointer;
        transition: all 0.2s;
        opacity: 0;
        position: relative;
    }

    .budget-item:hover .delete-item-btn {
        opacity: 1;
    }

    .delete-item-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        color: var(--budget-error);
    }

    .delete-item-btn svg {
        width: 16px;
        height: 16px;
    }

    /* Quick quote section */
    .quick-quote-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .quick-quote-toggle-row {
        display: flex;
        align-items: center;
    }

    .toggle-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .toggle-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--budget-primary);
    }

    .toggle-text {
        font-size: 14px;
        color: var(--budget-text);
    }

    .quick-quote-calc {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 10px;
        background: var(--budget-bg);
        border-radius: 8px;
    }

    .quick-quote-coverage {
        font-size: 12px;
        color: var(--budget-text-secondary);
    }

    .quick-quote-total {
        font-size: 16px;
        font-weight: 600;
        color: var(--budget-primary);
    }

    /* Empty category hint */
    .empty-category-hint {
        text-align: center;
        padding: 16px;
        color: var(--budget-text-secondary);
        font-size: 13px;
        font-style: italic;
    }

    /* Toast */
    .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        padding: 12px 24px;
        background: var(--budget-text);
        color: white;
        border-radius: 8px;
        font-size: 14px;
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
    }

    .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    .toast.success {
        background: var(--budget-success);
    }

    .toast.error {
        background: var(--budget-error);
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.25s ease;
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        background: var(--budget-surface);
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        z-index: 1001;
        width: 90%;
        max-width: 480px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        opacity: 0;
        visibility: hidden;
        transition: all 0.25s ease;
    }

    .modal-overlay.active + .modal,
    .modal.active {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid var(--budget-border);
    }

    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--budget-text);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-title-icon {
        font-size: 20px;
        font-variant-emoji: text;
    }

    .modal-close {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border: none;
        background: transparent;
        border-radius: 8px;
        color: var(--budget-text-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .modal-close:hover {
        background: var(--budget-bg);
        color: var(--budget-text);
    }

    .modal-close svg {
        width: 20px;
        height: 20px;
    }

    .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px 24px;
    }

    .modal-section {
        margin-bottom: 20px;
    }

    .modal-section:last-child {
        margin-bottom: 0;
    }

    .modal-section-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--budget-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 12px;
    }

    .suggestion-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
    }

    .suggestion-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 14px;
        background: var(--budget-bg);
        border: 2px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        color: var(--budget-text);
    }

    .suggestion-item:hover {
        border-color: var(--budget-primary-light);
        background: rgba(5, 150, 105, 0.05);
    }

    .suggestion-item.selected {
        border-color: var(--budget-primary);
        background: rgba(5, 150, 105, 0.1);
    }

    .suggestion-checkbox {
        width: 18px;
        height: 18px;
        border: 2px solid var(--budget-border);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s;
    }

    .suggestion-item.selected .suggestion-checkbox {
        background: var(--budget-primary);
        border-color: var(--budget-primary);
    }

    .suggestion-checkbox svg {
        width: 12px;
        height: 12px;
        color: white;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .suggestion-item.selected .suggestion-checkbox svg {
        opacity: 1;
    }

    .suggestion-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    .suggestion-item.disabled .suggestion-checkbox {
        background: var(--budget-border);
        border-color: var(--budget-border);
    }

    .suggestion-item.disabled .suggestion-checkbox svg {
        opacity: 1;
        color: var(--budget-text-secondary);
    }

    .suggestion-name {
        flex: 1;
        word-break: break-word;
        line-height: 1.3;
    }

    .custom-item-input-wrapper {
        display: flex;
        gap: 8px;
    }

    .custom-item-input {
        flex: 1;
        padding: 12px 14px;
        border: 2px solid var(--budget-border);
        border-radius: 8px;
        font-size: 14px;
        background: var(--budget-surface);
        color: var(--budget-text);
        transition: border-color 0.2s;
    }

    .custom-item-input:focus {
        outline: none;
        border-color: var(--budget-primary);
    }

    .custom-item-input::placeholder {
        color: var(--budget-text-secondary);
    }

    .add-custom-btn {
        padding: 12px 16px;
        background: var(--budget-bg);
        border: 2px solid var(--budget-border);
        border-radius: 8px;
        color: var(--budget-text-secondary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .add-custom-btn:hover {
        border-color: var(--budget-primary);
        color: var(--budget-primary);
    }

    .modal-footer {
        display: flex;
        gap: 12px;
        padding: 20px 24px;
        border-top: 1px solid var(--budget-border);
    }

    .modal-footer .btn {
        flex: 1;
    }

    .selected-count {
        font-size: 13px;
        color: var(--budget-text-secondary);
        padding: 8px 0;
    }

    /* Delete confirmation */
    .delete-item-btn.confirming {
        background: rgba(239, 68, 68, 0.1);
        color: var(--budget-error);
        opacity: 1;
    }

    .delete-item-btn.confirming::after {
        content: '?';
        font-size: 10px;
        font-weight: 600;
        position: absolute;
        top: 2px;
        right: 2px;
    }

    /* Item delete animation */
    .budget-item {
        transition: all 0.3s ease;
    }

    .budget-item.deleting {
        opacity: 0;
        transform: translateX(-20px);
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        margin-bottom: 0;
        overflow: hidden;
    }

    /* Fullscreen mode */
    .fullscreen-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        padding: 0;
        background: var(--budget-surface);
        border: 1px solid var(--budget-border);
        border-radius: 8px;
        color: var(--budget-text-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }

    .fullscreen-btn:hover {
        background: var(--budget-bg);
        color: var(--budget-text);
        border-color: var(--budget-primary-light);
    }

    .fullscreen-btn svg {
        width: 18px;
        height: 18px;
    }

    body.fullscreen-mode {
        overflow: hidden;
    }

    body.fullscreen-mode .site-header,
    body.fullscreen-mode .site-footer {
        display: none !important;
    }

    body.fullscreen-mode .main-content {
        position: fixed;
        inset: 0;
        z-index: 999;
        padding: 0;
    }

    body.fullscreen-mode .budget-container {
        height: 100vh;
        border-radius: 0;
    }

    body.fullscreen-mode .fullscreen-btn svg.icon-expand {
        display: none;
    }

    body.fullscreen-mode .fullscreen-btn svg.icon-collapse {
        display: block;
    }

    .fullscreen-btn svg.icon-collapse {
        display: none;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .budget-main {
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
        }

        .settings-panel {
            max-height: 280px;
        }
    }

    @media (max-width: 768px) {
        .budget-container {
            padding: 16px;
        }

        .budget-header {
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }

        .header-actions {
            width: 100%;
        }

        .header-actions .btn {
            flex: 1;
            justify-content: center;
        }

        .mode-selector {
            grid-template-columns: 1fr;
        }

        .budget-item {
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .budget-item-simple {
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .items-header,
        .items-header-simple {
            display: none;
        }

        .item-name {
            grid-column: 1 / -1;
            margin-bottom: 4px;
        }

        .item-input.item-note,
        .item-input.item-note-wide {
            grid-column: 1 / -1;
        }

        .item-subtotal-wrapper {
            grid-column: 1 / -1;
            justify-content: space-between;
        }

        .item-action-wrapper {
            width: auto;
        }

        .delete-item-btn {
            opacity: 1;
        }

        .modal {
            width: 95%;
            max-height: 90vh;
        }

        .suggestion-grid {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="budget-container">
    <header class="budget-header">
        <h1 class="budget-title">
            <span class="budget-title-icon">&#x1F3E0;</span>
            装修预算助手
        </h1>
        <div class="header-actions">
            <button id="fullscreen-btn" class="fullscreen-btn" title="全屏模式">
                <svg class="icon-expand" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3"/>
                    <path d="M21 8V5a2 2 0 0 0-2-2h-3"/>
                    <path d="M3 16v3a2 2 0 0 0 2 2h3"/>
                    <path d="M16 21h3a2 2 0 0 0 2-2v-3"/>
                </svg>
                <svg class="icon-collapse" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3v3a2 2 0 0 1-2 2H3"/>
                    <path d="M21 8h-3a2 2 0 0 1-2-2V3"/>
                    <path d="M3 16h3a2 2 0 0 1 2 2v3"/>
                    <path d="M16 21v-3a2 2 0 0 1 2-2h3"/>
                </svg>
            </button>
            <button id="reset-btn" class="btn btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
                重置
            </button>
            <button id="export-btn" class="btn btn-primary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7,10 12,15 17,10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                导出 Excel
            </button>
        </div>
    </header>

    <div class="budget-main">
        <aside class="settings-panel">
            <div class="settings-section">
                <h2 class="settings-section-title">基础信息</h2>
                <div class="form-group">
                    <label for="area">房屋面积</label>
                    <div class="input-with-unit">
                        <input type="number" id="area" placeholder="100" min="1" max="1000">
                        <span class="input-unit">平方米</span>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2 class="settings-section-title">装修方式</h2>
                <div class="mode-selector">
                    <div class="mode-option" data-mode="qingbao">
                        <div class="mode-option-name">清包</div>
                        <div class="mode-option-desc">只包人工</div>
                    </div>
                    <div class="mode-option active" data-mode="banbao">
                        <div class="mode-option-name">半包</div>
                        <div class="mode-option-desc">人工+辅材</div>
                    </div>
                    <div class="mode-option" data-mode="quanbao">
                        <div class="mode-option-name">全包</div>
                        <div class="mode-option-desc">人工+全部材料</div>
                    </div>
                    <div class="mode-option" data-mode="quanan">
                        <div class="mode-option-name">全案</div>
                        <div class="mode-option-desc">全包+设计+定制</div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2 class="settings-section-title">快捷报价</h2>
                <div class="quick-quote-section">
                    <div class="quick-quote-toggle-row">
                        <label class="toggle-label">
                            <input type="checkbox" id="quick-quote-toggle">
                            <span class="toggle-text">启用快捷报价</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="quick-quote-price">单价</label>
                        <div class="input-with-unit">
                            <input type="number" id="quick-quote-price" placeholder="500" min="0">
                            <span class="input-unit">元/平米</span>
                        </div>
                    </div>
                    <div class="quick-quote-calc">
                        <span id="quick-quote-coverage" class="quick-quote-coverage">覆盖: 基装部分</span>
                        <span id="quick-quote-total" class="quick-quote-total">= ¥0</span>
                    </div>
                </div>
            </div>

            <div class="summary-card">
                <div class="summary-total-label">预算总计</div>
                <div class="summary-total-amount" id="total-amount">¥0</div>
                <div class="summary-breakdown">
                    <div class="summary-row" id="summary-quick-quote-row" style="display: none;">
                        <span class="summary-row-label">快捷报价</span>
                        <span class="summary-row-value" id="summary-quick-quote">¥0</span>
                    </div>
                    <div class="summary-row" id="summary-design-row">
                        <span class="summary-row-label">设计</span>
                        <span class="summary-row-value" id="summary-design">¥0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-row-label">硬装部分</span>
                        <span class="summary-row-value" id="summary-hardfit">¥0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-row-label">主材部分</span>
                        <span class="summary-row-value" id="summary-materials">¥0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-row-label">全屋定制</span>
                        <span class="summary-row-value" id="summary-custom-furniture">¥0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-row-label">家具家电</span>
                        <span class="summary-row-value" id="summary-furniture">¥0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-row-label">软装配饰</span>
                        <span class="summary-row-value" id="summary-soft">¥0</span>
                    </div>
                </div>
            </div>
        </aside>

        <main class="budget-panel">
            <div class="budget-panel-header">
                <h2 class="budget-panel-title">预算明细</h2>
                <span style="font-size: 12px; color: var(--budget-text-secondary);">参考价格仅供参考，请根据实际报价填写</span>
            </div>
            <div class="budget-panel-body" id="budget-list">
                <!-- Dynamic content -->
            </div>
        </main>
    </div>
</div>

<div id="toast" class="toast"></div>

<!-- Add Item Modal -->
<div id="modal-overlay" class="modal-overlay"></div>
<div id="add-item-modal" class="modal">
    <div class="modal-header">
        <h3 class="modal-title">
            <span class="modal-title-icon" id="modal-category-icon">&#x1F4E6;</span>
            <span id="modal-category-name">添加项目</span>
        </h3>
        <button class="modal-close" id="modal-close">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    </div>
    <div class="modal-body">
        <div class="modal-section">
            <div class="modal-section-title">选择项目</div>
            <div class="suggestion-grid" id="suggestion-grid">
                <!-- Dynamic content -->
            </div>
        </div>
        <div class="modal-section">
            <div class="modal-section-title">自定义项目</div>
            <div class="custom-item-input-wrapper">
                <input type="text" class="custom-item-input" id="custom-item-input" placeholder="输入自定义项目名称">
                <button class="add-custom-btn" id="add-custom-btn">添加</button>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <div class="selected-count" id="selected-count">已选择 0 个项目</div>
        <button class="btn btn-secondary" id="modal-cancel">取消</button>
        <button class="btn btn-primary" id="modal-confirm">确认添加</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
// Budget categories with suggestions (no preset items - user adds as needed)
// modeConfig: { tag: 'included'|'self'|'labor', display: 'detailed'|'simple' }
const budgetCategories = {
    design: {
        name: '设计',
        icon: '&#x270F;',
        suggestions: ['设计费', '效果图', '施工图', '量房费', '设计方案修改'],
        modeConfig: {
            qingbao: { tag: 'self', display: 'detailed' },
            banbao: { tag: 'self', display: 'detailed' },
            quanbao: { tag: 'self', display: 'detailed' },
            quanan: { tag: 'included', display: 'simple' }
        }
    },
    demolition: {
        name: '拆改工程',
        icon: '&#x1F6A7;',
        suggestions: ['拆墙', '砌墙', '铲墙皮', '垃圾清运', '拆除门窗', '拆除地板', '拆除吊顶', '开槽'],
        modeConfig: {
            qingbao: { tag: 'labor', display: 'detailed' },
            banbao: { tag: 'included', display: 'detailed' },
            quanbao: { tag: 'included', display: 'simple' },
            quanan: { tag: 'included', display: 'simple' }
        }
    },
    plumbing: {
        name: '水电工程',
        icon: '&#x1F4A1;',
        suggestions: ['电路改造', '水路改造', '开关插座安装', '弱电布线', '网线布置', '强电箱', '地暖铺设', '新风系统'],
        modeConfig: {
            qingbao: { tag: 'labor', display: 'detailed' },
            banbao: { tag: 'included', display: 'detailed' },
            quanbao: { tag: 'included', display: 'simple' },
            quanan: { tag: 'included', display: 'simple' }
        }
    },
    tiling: {
        name: '瓦工工程',
        icon: '&#x1F9F1;',
        suggestions: ['防水处理', '地面贴砖', '墙面贴砖', '地面找平', '过门石', '门槛石', '窗台石', '美缝'],
        modeConfig: {
            qingbao: { tag: 'labor', display: 'detailed' },
            banbao: { tag: 'included', display: 'detailed' },
            quanbao: { tag: 'included', display: 'simple' },
            quanan: { tag: 'included', display: 'simple' }
        }
    },
    carpentry: {
        name: '木工工程',
        icon: '&#x1FA9A;',
        suggestions: ['吊顶', '电视背景墙', '窗帘盒', '石膏线', '隔断墙', '造型墙'],
        modeConfig: {
            qingbao: { tag: 'labor', display: 'detailed' },
            banbao: { tag: 'included', display: 'detailed' },
            quanbao: { tag: 'included', display: 'simple' },
            quanan: { tag: 'included', display: 'simple' }
        }
    },
    painting: {
        name: '油漆工程',
        icon: '&#x1F3A8;',
        suggestions: ['墙面基层处理', '乳胶漆', '墙面批腻子', '墙面打磨', '艺术漆', '木器漆'],
        modeConfig: {
            qingbao: { tag: 'labor', display: 'detailed' },
            banbao: { tag: 'included', display: 'detailed' },
            quanbao: { tag: 'included', display: 'simple' },
            quanan: { tag: 'included', display: 'simple' }
        }
    },
    materials: {
        name: '主材',
        icon: '&#x1F4E6;',
        suggestions: ['瓷砖', '地板', '室内门', '橱柜', '洁具套装', '灯具', '五金件', '开关面板', '窗户', '防盗门'],
        modeConfig: {
            qingbao: { tag: 'self', display: 'detailed' },
            banbao: { tag: 'self', display: 'detailed' },
            quanbao: { tag: 'included', display: 'simple' },
            quanan: { tag: 'included', display: 'simple' }
        }
    },
    customFurniture: {
        name: '全屋定制',
        icon: '&#x1FA91;',
        suggestions: ['衣柜', '橱柜', '书柜', '书桌', '榻榻米', '鞋柜', '阳台柜', '浴室柜', '餐边柜', '玄关柜'],
        modeConfig: {
            qingbao: { tag: 'self', display: 'detailed' },
            banbao: { tag: 'self', display: 'detailed' },
            quanbao: { tag: 'self', display: 'detailed' },
            quanan: { tag: 'included', display: 'simple' }
        }
    },
    furniture: {
        name: '家具家电',
        icon: '&#x1F6CB;',
        suggestions: ['沙发', '床', '床垫', '餐桌椅', '空调', '冰箱', '洗衣机', '电视', '油烟机', '燃气灶', '热水器', '洗碗机'],
        modeConfig: {
            qingbao: { tag: 'self', display: 'detailed' },
            banbao: { tag: 'self', display: 'detailed' },
            quanbao: { tag: 'self', display: 'detailed' },
            quanan: { tag: 'self', display: 'detailed' }
        }
    },
    soft: {
        name: '软装配饰',
        icon: '&#x1F3A0;',
        suggestions: ['窗帘', '地毯', '装饰画', '绿植', '抱枕', '床品', '餐具', '摆件'],
        modeConfig: {
            qingbao: { tag: 'self', display: 'detailed' },
            banbao: { tag: 'self', display: 'detailed' },
            quanbao: { tag: 'self', display: 'detailed' },
            quanan: { tag: 'self', display: 'detailed' }
        }
    }
};

// Quick quote coverage by decoration mode
const quickQuoteCoverage = {
    qingbao: {
        name: '基装人工',
        categories: ['demolition', 'plumbing', 'tiling', 'carpentry', 'painting']
    },
    banbao: {
        name: '基装部分',
        categories: ['demolition', 'plumbing', 'tiling', 'carpentry', 'painting']
    },
    quanbao: {
        name: '硬装部分',
        categories: ['demolition', 'plumbing', 'tiling', 'carpentry', 'painting', 'materials']
    },
    quanan: {
        name: '全案部分',
        categories: ['design', 'demolition', 'plumbing', 'tiling', 'carpentry', 'painting', 'materials', 'customFurniture']
    }
};

class DecorationBudget {
    constructor() {
        this.mode = 'banbao';
        this.area = 100;
        this.items = {}; // Store all items per category (user-added)
        this.collapsedCategories = new Set();
        this.itemCounter = 0;
        this.quickQuote = {
            enabled: false,
            unitPrice: 0
        };
        this.customSuggestions = {}; // User-added custom suggestions
        this.isFullscreen = false;
        this.pendingDeleteBtn = null; // For delete confirmation
        this.currentModalCategory = null; // For add item modal
        this.selectedSuggestions = new Set(); // Selected items in modal
    }

    init() {
        this.loadFromStorage();
        this.bindEvents();
        this.render();
    }

    loadFromStorage() {
        try {
            const saved = localStorage.getItem('decoration-budget-v4');
            if (saved) {
                const data = JSON.parse(saved);
                this.mode = data.mode || 'banbao';
                this.area = data.area || 100;
                this.items = data.items || {};
                this.itemCounter = data.itemCounter || 0;
                this.quickQuote = data.quickQuote || { enabled: false, unitPrice: 0 };
                this.customSuggestions = data.customSuggestions || {};
                this.collapsedCategories = new Set(data.collapsedCategories || []);
                this.isFullscreen = data.isFullscreen || false;

                // Update UI
                document.getElementById('area').value = this.area;
                document.querySelectorAll('.mode-option').forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.mode === this.mode);
                });
                document.getElementById('quick-quote-price').value = this.quickQuote.unitPrice || '';
                document.getElementById('quick-quote-toggle').checked = this.quickQuote.enabled;

                // Restore fullscreen mode
                if (this.isFullscreen) {
                    document.body.classList.add('fullscreen-mode');
                }
            }
        } catch (e) {
            console.error('Failed to load from storage:', e);
        }
    }

    saveToStorage() {
        try {
            localStorage.setItem('decoration-budget-v4', JSON.stringify({
                mode: this.mode,
                area: this.area,
                items: this.items,
                itemCounter: this.itemCounter,
                quickQuote: this.quickQuote,
                customSuggestions: this.customSuggestions,
                collapsedCategories: Array.from(this.collapsedCategories),
                isFullscreen: this.isFullscreen
            }));
        } catch (e) {
            console.error('Failed to save to storage:', e);
        }
    }

    bindEvents() {
        // Mode selector
        document.querySelectorAll('.mode-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('.mode-option').forEach(o => o.classList.remove('active'));
                opt.classList.add('active');
                this.mode = opt.dataset.mode;
                this.updateQuickQuoteInfo();
                this.render();
                this.saveToStorage();
            });
        });

        // Area input
        document.getElementById('area').addEventListener('input', (e) => {
            this.area = parseFloat(e.target.value) || 0;
            this.updateQuickQuoteTotal();
            this.calculateTotals();
            this.saveToStorage();
        });

        // Quick quote toggle
        document.getElementById('quick-quote-toggle').addEventListener('change', (e) => {
            this.quickQuote.enabled = e.target.checked;
            this.updateQuickQuoteTotal();
            this.calculateTotals();
            this.saveToStorage();
        });

        // Quick quote price input
        document.getElementById('quick-quote-price').addEventListener('input', (e) => {
            this.quickQuote.unitPrice = parseFloat(e.target.value) || 0;
            this.updateQuickQuoteTotal();
            this.calculateTotals();
            this.saveToStorage();
        });

        // Reset button
        document.getElementById('reset-btn').addEventListener('click', () => {
            if (confirm('确定要重置所有预算数据吗？')) {
                this.items = {};
                this.itemCounter = 0;
                this.quickQuote = { enabled: false, unitPrice: 0 };
                this.customSuggestions = {};
                this.mode = 'banbao';
                this.area = 100;
                document.getElementById('area').value = 100;
                document.getElementById('quick-quote-price').value = '';
                document.getElementById('quick-quote-toggle').checked = false;
                document.querySelectorAll('.mode-option').forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.mode === 'banbao');
                });
                localStorage.removeItem('decoration-budget-v4');
                this.updateQuickQuoteInfo();
                this.render();
                this.showToast('已重置预算数据', 'success');
            }
        });

        // Export button
        document.getElementById('export-btn').addEventListener('click', () => this.exportToExcel());

        // Fullscreen button
        document.getElementById('fullscreen-btn').addEventListener('click', () => this.toggleFullscreen());

        // Modal events
        document.getElementById('modal-overlay').addEventListener('click', () => this.closeModal());
        document.getElementById('modal-close').addEventListener('click', () => this.closeModal());
        document.getElementById('modal-cancel').addEventListener('click', () => this.closeModal());
        document.getElementById('modal-confirm').addEventListener('click', () => this.confirmAddItems());
        document.getElementById('add-custom-btn').addEventListener('click', () => this.addCustomItemToModal());
        document.getElementById('custom-item-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.addCustomItemToModal();
            }
        });

        // Global keyboard events
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (this.isModalOpen()) {
                    this.closeModal();
                } else if (this.isFullscreen) {
                    this.toggleFullscreen();
                }
                // Clear pending delete confirmation
                if (this.pendingDeleteBtn) {
                    this.pendingDeleteBtn.classList.remove('confirming');
                    this.pendingDeleteBtn = null;
                }
            }
        });

        // Click outside to cancel delete confirmation
        document.addEventListener('click', (e) => {
            if (this.pendingDeleteBtn && !e.target.closest('.delete-item-btn')) {
                this.pendingDeleteBtn.classList.remove('confirming');
                this.pendingDeleteBtn = null;
            }
        });

        // Initialize quick quote info
        this.updateQuickQuoteInfo();
    }

    updateQuickQuoteInfo() {
        const coverage = quickQuoteCoverage[this.mode];
        const coverageNames = coverage.categories.map(k => budgetCategories[k].name).join('、');
        document.getElementById('quick-quote-coverage').textContent = `覆盖: ${coverageNames}`;
        this.updateQuickQuoteTotal();
    }

    updateQuickQuoteTotal() {
        const total = this.quickQuote.enabled ? this.area * this.quickQuote.unitPrice : 0;
        document.getElementById('quick-quote-total').textContent = `= ¥${total.toLocaleString()}`;
    }

    getDisplayMode(categoryKey) {
        const category = budgetCategories[categoryKey];
        const config = category.modeConfig[this.mode];
        return config ? config.display : 'detailed';
    }

    isCategoryVisible(categoryKey) {
        const category = budgetCategories[categoryKey];
        return !!category.modeConfig[this.mode];
    }

    getSuggestions(categoryKey) {
        const base = budgetCategories[categoryKey].suggestions || [];
        const custom = this.customSuggestions[categoryKey] || [];
        return [...new Set([...base, ...custom])];
    }

    // Fullscreen mode
    toggleFullscreen() {
        this.isFullscreen = !this.isFullscreen;
        document.body.classList.toggle('fullscreen-mode', this.isFullscreen);
        this.saveToStorage();
    }

    // Modal methods
    isModalOpen() {
        return document.getElementById('modal-overlay').classList.contains('active');
    }

    showAddItemModal(categoryKey) {
        const category = budgetCategories[categoryKey];
        this.currentModalCategory = categoryKey;
        this.selectedSuggestions = new Set();

        // Update modal header
        document.getElementById('modal-category-icon').innerHTML = category.icon;
        document.getElementById('modal-category-name').textContent = `添加${category.name}项目`;

        // Render suggestions grid
        const suggestions = this.getSuggestions(categoryKey);
        const existingNames = (this.items[categoryKey] || []).map(i => i.name);
        const grid = document.getElementById('suggestion-grid');

        grid.innerHTML = suggestions.map(name => {
            const isExisting = existingNames.includes(name);
            return `
                <div class="suggestion-item ${isExisting ? 'disabled' : ''}"
                     data-name="${name}"
                     ${isExisting ? 'title="已添加"' : ''}>
                    <div class="suggestion-checkbox">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <polyline points="20,6 9,17 4,12"/>
                        </svg>
                    </div>
                    <span class="suggestion-name">${name}</span>
                </div>
            `;
        }).join('');

        // Bind suggestion click events
        grid.querySelectorAll('.suggestion-item:not(.disabled)').forEach(item => {
            item.addEventListener('click', () => {
                const name = item.dataset.name;
                if (this.selectedSuggestions.has(name)) {
                    this.selectedSuggestions.delete(name);
                    item.classList.remove('selected');
                } else {
                    this.selectedSuggestions.add(name);
                    item.classList.add('selected');
                }
                this.updateSelectedCount();
            });
        });

        // Clear custom input
        document.getElementById('custom-item-input').value = '';
        this.updateSelectedCount();

        // Show modal
        document.getElementById('modal-overlay').classList.add('active');
        document.getElementById('add-item-modal').classList.add('active');
    }

    closeModal() {
        document.getElementById('modal-overlay').classList.remove('active');
        document.getElementById('add-item-modal').classList.remove('active');
        this.currentModalCategory = null;
        this.selectedSuggestions = new Set();
    }

    updateSelectedCount() {
        const count = this.selectedSuggestions.size;
        document.getElementById('selected-count').textContent = `已选择 ${count} 个项目`;
    }

    addCustomItemToModal() {
        const input = document.getElementById('custom-item-input');
        const name = input.value.trim();
        if (!name) return;

        // Add to selected
        this.selectedSuggestions.add(name);

        // Add to suggestions grid
        const grid = document.getElementById('suggestion-grid');
        const existingItem = grid.querySelector(`[data-name="${name}"]`);

        if (existingItem) {
            existingItem.classList.add('selected');
        } else {
            const newItem = document.createElement('div');
            newItem.className = 'suggestion-item selected';
            newItem.dataset.name = name;
            newItem.innerHTML = `
                <div class="suggestion-checkbox">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20,6 9,17 4,12"/>
                    </svg>
                </div>
                <span class="suggestion-name">${name}</span>
            `;
            newItem.addEventListener('click', () => {
                if (this.selectedSuggestions.has(name)) {
                    this.selectedSuggestions.delete(name);
                    newItem.classList.remove('selected');
                } else {
                    this.selectedSuggestions.add(name);
                    newItem.classList.add('selected');
                }
                this.updateSelectedCount();
            });
            grid.appendChild(newItem);
        }

        input.value = '';
        this.updateSelectedCount();
    }

    confirmAddItems() {
        if (this.selectedSuggestions.size === 0) {
            this.showToast('请选择至少一个项目', 'error');
            return;
        }

        const categoryKey = this.currentModalCategory;
        if (!this.items[categoryKey]) {
            this.items[categoryKey] = [];
        }

        // Add all selected items
        for (const name of this.selectedSuggestions) {
            const id = `item_${++this.itemCounter}`;
            this.items[categoryKey].push({
                id,
                name,
                unit: '项',
                qty: 0,
                price: 0,
                note: '',
                total: 0
            });

            // Add to custom suggestions if not in base suggestions
            const baseSuggestions = budgetCategories[categoryKey].suggestions || [];
            if (!baseSuggestions.includes(name)) {
                if (!this.customSuggestions[categoryKey]) {
                    this.customSuggestions[categoryKey] = [];
                }
                if (!this.customSuggestions[categoryKey].includes(name)) {
                    this.customSuggestions[categoryKey].push(name);
                }
            }
        }

        this.saveToStorage();
        this.closeModal();
        this.render();
        this.showToast(`已添加 ${this.selectedSuggestions.size} 个项目`, 'success');
    }

    // Delete with confirmation
    handleDeleteClick(btn, categoryKey, itemId) {
        if (this.pendingDeleteBtn === btn) {
            // Second click - confirm delete
            this.pendingDeleteBtn = null;
            this.deleteItemWithAnimation(categoryKey, itemId, btn);
        } else {
            // First click - show confirmation
            if (this.pendingDeleteBtn) {
                this.pendingDeleteBtn.classList.remove('confirming');
            }
            this.pendingDeleteBtn = btn;
            btn.classList.add('confirming');
        }
    }

    deleteItemWithAnimation(categoryKey, itemId, btn) {
        const itemEl = btn.closest('.budget-item');
        if (itemEl) {
            itemEl.classList.add('deleting');
            setTimeout(() => {
                this.deleteItem(categoryKey, itemId);
            }, 300);
        } else {
            this.deleteItem(categoryKey, itemId);
        }
    }

    // Items management (all items are user-added now)
    addItem(categoryKey, name = '') {
        if (!this.items[categoryKey]) {
            this.items[categoryKey] = [];
        }
        const id = `item_${++this.itemCounter}`;
        const displayMode = this.getDisplayMode(categoryKey);
        this.items[categoryKey].push({
            id,
            name: name,
            unit: '项',
            qty: 0,
            price: 0,
            note: '',
            total: 0
        });
        this.saveToStorage();
        this.render();
    }

    deleteItem(categoryKey, itemId) {
        if (this.items[categoryKey]) {
            this.items[categoryKey] = this.items[categoryKey].filter(i => i.id !== itemId);
            this.saveToStorage();
            this.render();
        }
    }

    updateItem(categoryKey, itemId, field, value) {
        const items = this.items[categoryKey];
        if (items) {
            const item = items.find(i => i.id === itemId);
            if (item) {
                item[field] = value;
                // Add to custom suggestions if it's a new name
                if (field === 'name' && value && !this.getSuggestions(categoryKey).includes(value)) {
                    if (!this.customSuggestions[categoryKey]) {
                        this.customSuggestions[categoryKey] = [];
                    }
                    if (!this.customSuggestions[categoryKey].includes(value)) {
                        this.customSuggestions[categoryKey].push(value);
                    }
                }
                this.saveToStorage();
            }
        }
    }

    render() {
        const container = document.getElementById('budget-list');
        let html = '';

        for (const [categoryKey, category] of Object.entries(budgetCategories)) {
            if (!this.isCategoryVisible(categoryKey)) continue;

            const isCollapsed = this.collapsedCategories.has(categoryKey);
            const displayMode = this.getDisplayMode(categoryKey);
            const subtotal = this.calculateCategorySubtotal(categoryKey);
            const items = this.items[categoryKey] || [];

            html += `
                <div class="budget-category" data-category="${categoryKey}">
                    <div class="category-header ${isCollapsed ? 'collapsed' : ''}" data-category="${categoryKey}">
                        <div class="category-title">
                            <span class="category-icon">${category.icon}</span>
                            <span class="category-name">${category.name}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <span class="category-subtotal">¥${subtotal.toLocaleString()}</span>
                            <svg class="category-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6,9 12,15 18,9"/>
                            </svg>
                        </div>
                    </div>
                    <div class="category-items ${isCollapsed ? 'collapsed' : ''}">
                        ${items.length > 0 ? this.renderItemsHeader(displayMode) : ''}
                        ${items.map(item => this.renderItem(categoryKey, item, displayMode)).join('')}
                        ${items.length === 0 ? '<div class="empty-category-hint">点击下方按钮添加项目</div>' : ''}
                        <button class="add-item-btn" data-category="${categoryKey}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            添加项目
                        </button>
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
        this.bindDynamicEvents(container);
        this.calculateTotals();
    }

    renderItemsHeader(displayMode) {
        if (displayMode === 'simple') {
            return `
                <div class="items-header items-header-simple">
                    <span>项目名称</span>
                    <span>工艺说明</span>
                    <span>总价</span>
                    <span></span>
                </div>
            `;
        }
        return `
            <div class="items-header">
                <span>项目名称</span>
                <span>数量</span>
                <span>单价 (元)</span>
                <span>品牌/备注</span>
                <span>小计</span>
            </div>
        `;
    }

    renderItem(categoryKey, item, displayMode) {
        if (displayMode === 'simple') {
            return this.renderSimpleItem(categoryKey, item);
        }
        return this.renderDetailedItem(categoryKey, item);
    }

    renderDetailedItem(categoryKey, item) {
        const subtotal = (item.qty || 0) * (item.price || 0);

        return `
            <div class="budget-item" data-category="${categoryKey}" data-item="${item.id}">
                <span class="item-name" title="${item.name || '未命名'}">${item.name || '未命名'}</span>
                <input type="number" class="item-input item-qty"
                    data-category="${categoryKey}"
                    data-item="${item.id}"
                    value="${item.qty || ''}"
                    min="0"
                    placeholder="数量">
                <input type="number" class="item-input item-price"
                    data-category="${categoryKey}"
                    data-item="${item.id}"
                    value="${item.price || ''}"
                    min="0"
                    placeholder="单价">
                <input type="text" class="item-input item-note"
                    data-category="${categoryKey}"
                    data-item="${item.id}"
                    value="${item.note || ''}"
                    placeholder="品牌/备注">
                <div class="item-subtotal-wrapper">
                    <span class="item-subtotal" data-category="${categoryKey}" data-item="${item.id}">¥${subtotal.toLocaleString()}</span>
                    <button class="delete-item-btn" data-category="${categoryKey}" data-item="${item.id}" title="删除项目">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    }

    renderSimpleItem(categoryKey, item) {
        return `
            <div class="budget-item budget-item-simple" data-category="${categoryKey}" data-item="${item.id}">
                <span class="item-name" title="${item.name || '未命名'}">${item.name || '未命名'}</span>
                <input type="text" class="item-input item-note item-note-wide"
                    data-category="${categoryKey}"
                    data-item="${item.id}"
                    value="${item.note || ''}"
                    placeholder="工艺说明（如：东方雨虹，厨卫刷三遍）">
                <input type="number" class="item-input item-total"
                    data-category="${categoryKey}"
                    data-item="${item.id}"
                    value="${item.total || ''}"
                    min="0"
                    placeholder="总价">
                <div class="item-action-wrapper">
                    <button class="delete-item-btn" data-category="${categoryKey}" data-item="${item.id}" title="删除项目">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    }

    bindDynamicEvents(container) {
        // Category collapse events
        container.querySelectorAll('.category-header').forEach(header => {
            header.addEventListener('click', (e) => {
                if (e.target.closest('.add-item-btn') || e.target.closest('.delete-item-btn')) return;
                const categoryKey = header.dataset.category;
                if (this.collapsedCategories.has(categoryKey)) {
                    this.collapsedCategories.delete(categoryKey);
                } else {
                    this.collapsedCategories.add(categoryKey);
                }
                header.classList.toggle('collapsed');
                header.nextElementSibling.classList.toggle('collapsed');
                this.saveToStorage(); // Save collapse state
            });
        });

        // Add item buttons - now open modal
        container.querySelectorAll('.add-item-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.showAddItemModal(btn.dataset.category);
            });
        });

        // Delete item buttons - now use confirmation
        container.querySelectorAll('.delete-item-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.handleDeleteClick(btn, btn.dataset.category, btn.dataset.item);
            });
        });

        // Input events for detailed mode
        container.querySelectorAll('.item-qty').forEach(input => {
            input.addEventListener('input', (e) => {
                const { category, item } = e.target.dataset;
                const value = parseFloat(e.target.value) || 0;
                this.updateItem(category, item, 'qty', value);
                this.updateItemSubtotal(category, item);
                this.updateCategorySubtotal(category);
            });
        });

        container.querySelectorAll('.item-price').forEach(input => {
            input.addEventListener('input', (e) => {
                const { category, item } = e.target.dataset;
                const value = parseFloat(e.target.value) || 0;
                this.updateItem(category, item, 'price', value);
                this.updateItemSubtotal(category, item);
                this.updateCategorySubtotal(category);
            });
        });

        container.querySelectorAll('.item-note').forEach(input => {
            input.addEventListener('input', (e) => {
                const { category, item } = e.target.dataset;
                this.updateItem(category, item, 'note', e.target.value);
            });
        });

        // Input events for simple mode total
        container.querySelectorAll('.item-total').forEach(input => {
            input.addEventListener('input', (e) => {
                const { category, item } = e.target.dataset;
                const value = parseFloat(e.target.value) || 0;
                this.updateItem(category, item, 'total', value);
                this.updateCategorySubtotal(category);
                this.calculateTotals();
            });
        });
    }

    updateItemSubtotal(categoryKey, itemId) {
        const items = this.items[categoryKey];
        const item = items?.find(i => i.id === itemId);
        if (item) {
            const subtotal = (item.qty || 0) * (item.price || 0);
            const el = document.querySelector(`.item-subtotal[data-category="${categoryKey}"][data-item="${itemId}"]`);
            if (el) {
                el.textContent = `¥${subtotal.toLocaleString()}`;
            }
        }
    }

    updateCategorySubtotal(categoryKey) {
        const subtotal = this.calculateCategorySubtotal(categoryKey);
        const el = document.querySelector(`.category-header[data-category="${categoryKey}"] .category-subtotal`);
        if (el) {
            el.textContent = `¥${subtotal.toLocaleString()}`;
        }
        this.calculateTotals();
    }

    calculateCategorySubtotal(categoryKey) {
        let subtotal = 0;
        const displayMode = this.getDisplayMode(categoryKey);
        const items = this.items[categoryKey] || [];

        for (const item of items) {
            if (displayMode === 'simple') {
                subtotal += item.total || 0;
            } else {
                subtotal += (item.qty || 0) * (item.price || 0);
            }
        }

        return subtotal;
    }

    calculateTotals() {
        let design = 0;
        let hardfit = 0;
        let materials = 0;
        let customFurniture = 0;
        let furniture = 0;
        let soft = 0;
        let quickQuoteTotal = 0;

        const hardCategories = ['demolition', 'plumbing', 'tiling', 'carpentry', 'painting'];

        // Calculate quick quote total
        if (this.quickQuote.enabled && this.quickQuote.unitPrice > 0) {
            quickQuoteTotal = this.area * this.quickQuote.unitPrice;
        }

        // Calculate detail totals
        if (this.isCategoryVisible('design')) {
            design = this.calculateCategorySubtotal('design');
        }

        for (const categoryKey of hardCategories) {
            if (this.isCategoryVisible(categoryKey)) {
                hardfit += this.calculateCategorySubtotal(categoryKey);
            }
        }

        if (this.isCategoryVisible('materials')) {
            materials = this.calculateCategorySubtotal('materials');
        }
        if (this.isCategoryVisible('customFurniture')) {
            customFurniture = this.calculateCategorySubtotal('customFurniture');
        }
        if (this.isCategoryVisible('furniture')) {
            furniture = this.calculateCategorySubtotal('furniture');
        }
        if (this.isCategoryVisible('soft')) {
            soft = this.calculateCategorySubtotal('soft');
        }

        const detailTotal = design + hardfit + materials + customFurniture + furniture + soft;
        const total = quickQuoteTotal + detailTotal;

        document.getElementById('total-amount').textContent = `¥${total.toLocaleString()}`;

        // Update quick quote row
        const quickQuoteRow = document.getElementById('summary-quick-quote-row');
        if (quickQuoteRow) {
            quickQuoteRow.style.display = this.quickQuote.enabled ? 'flex' : 'none';
            document.getElementById('summary-quick-quote').textContent = `¥${quickQuoteTotal.toLocaleString()}`;
        }

        // Update design row (always visible now)
        const designRow = document.getElementById('summary-design-row');
        if (designRow) {
            designRow.style.display = 'flex';
            document.getElementById('summary-design').textContent = `¥${design.toLocaleString()}`;
        }

        document.getElementById('summary-hardfit').textContent = `¥${hardfit.toLocaleString()}`;
        document.getElementById('summary-materials').textContent = `¥${materials.toLocaleString()}`;

        const customFurnitureEl = document.getElementById('summary-custom-furniture');
        if (customFurnitureEl) {
            customFurnitureEl.textContent = `¥${customFurniture.toLocaleString()}`;
        }

        document.getElementById('summary-furniture').textContent = `¥${furniture.toLocaleString()}`;
        document.getElementById('summary-soft').textContent = `¥${soft.toLocaleString()}`;
    }

    exportToExcel() {
        const wb = XLSX.utils.book_new();

        const modeNames = { qingbao: '清包', banbao: '半包', quanbao: '全包', quanan: '全案' };

        // Calculate totals
        let design = 0, hardfit = 0, materials = 0, customFurniture = 0, furniture = 0, soft = 0;
        let quickQuoteTotal = 0;
        const hardCategories = ['demolition', 'plumbing', 'tiling', 'carpentry', 'painting'];

        if (this.quickQuote.enabled && this.quickQuote.unitPrice > 0) {
            quickQuoteTotal = this.area * this.quickQuote.unitPrice;
        }

        if (this.isCategoryVisible('design')) {
            design = this.calculateCategorySubtotal('design');
        }
        for (const categoryKey of hardCategories) {
            if (this.isCategoryVisible(categoryKey)) {
                hardfit += this.calculateCategorySubtotal(categoryKey);
            }
        }
        if (this.isCategoryVisible('materials')) {
            materials = this.calculateCategorySubtotal('materials');
        }
        if (this.isCategoryVisible('customFurniture')) {
            customFurniture = this.calculateCategorySubtotal('customFurniture');
        }
        if (this.isCategoryVisible('furniture')) {
            furniture = this.calculateCategorySubtotal('furniture');
        }
        if (this.isCategoryVisible('soft')) {
            soft = this.calculateCategorySubtotal('soft');
        }

        const summaryData = [
            ['装修预算汇总表'],
            [],
            ['基础信息'],
            ['房屋面积', `${this.area} 平方米`],
            ['装修方式', modeNames[this.mode]],
            [],
            ['费用汇总'],
        ];

        if (this.quickQuote.enabled) {
            const coverage = quickQuoteCoverage[this.mode];
            summaryData.push([`快捷报价 (${coverage.name})`, quickQuoteTotal, `${this.quickQuote.unitPrice} 元/平米`]);
        }

        summaryData.push(['设计费', design]);
        summaryData.push(['硬装部分', hardfit]);
        summaryData.push(['主材部分', materials]);
        summaryData.push(['全屋定制', customFurniture]);
        summaryData.push(['家具家电', furniture]);
        summaryData.push(['软装配饰', soft]);
        summaryData.push([]);
        summaryData.push(['预算总计', quickQuoteTotal + design + hardfit + materials + customFurniture + furniture + soft]);

        const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, summaryWs, '预算汇总');

        // Detail sheet
        const detailData = [
            ['装修预算明细表'],
            [],
        ];

        // Check display modes
        const hasDetailedMode = Object.keys(budgetCategories).some(k =>
            this.isCategoryVisible(k) && this.getDisplayMode(k) === 'detailed'
        );
        const hasSimpleMode = Object.keys(budgetCategories).some(k =>
            this.isCategoryVisible(k) && this.getDisplayMode(k) === 'simple'
        );

        if (hasDetailedMode && hasSimpleMode) {
            detailData.push(['分类', '项目', '显示模式', '数量', '单价 (元)', '工艺说明', '总价 (元)']);
        } else if (hasSimpleMode) {
            detailData.push(['分类', '项目', '工艺说明', '总价 (元)']);
        } else {
            detailData.push(['分类', '项目', '数量', '单价 (元)', '品牌/备注', '小计 (元)']);
        }

        for (const [categoryKey, category] of Object.entries(budgetCategories)) {
            if (!this.isCategoryVisible(categoryKey)) continue;

            const displayMode = this.getDisplayMode(categoryKey);
            const items = this.items[categoryKey] || [];

            for (const item of items) {
                const itemName = item.name || '未命名项目';

                if (displayMode === 'simple') {
                    const total = item.total || 0;
                    if (total > 0 || item.note) {
                        if (hasDetailedMode && hasSimpleMode) {
                            detailData.push([category.name, itemName, '简化', '', '', item.note || '', total]);
                        } else {
                            detailData.push([category.name, itemName, item.note || '', total]);
                        }
                    }
                } else {
                    const subtotal = (item.qty || 0) * (item.price || 0);
                    if (item.qty > 0 || item.price > 0) {
                        if (hasDetailedMode && hasSimpleMode) {
                            detailData.push([category.name, itemName, '详细', item.qty || 0, item.price || 0, item.note || '', subtotal]);
                        } else {
                            detailData.push([category.name, itemName, item.qty || 0, item.price || 0, item.note || '', subtotal]);
                        }
                    }
                }
            }
        }

        const detailWs = XLSX.utils.aoa_to_sheet(detailData);
        XLSX.utils.book_append_sheet(wb, detailWs, '预算明细');

        const fileName = `装修预算_${this.area}平米_${modeNames[this.mode]}_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`;
        XLSX.writeFile(wb, fileName);
        this.showToast('Excel 导出成功', 'success');
    }

    showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type} show`;
        setTimeout(() => {
            toast.className = 'toast';
        }, 2000);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const budget = new DecorationBudget();
    budget.init();
});
</script>
{% endblock %}
