{% extends "base.html" %}

{% block title %}本命星盘 - {{ site.title }}{% endblock %}

{% block description %}输入出生日期、时间和地点，生成专业级本命星盘图，显示行星位置和相位{% endblock %}

{% block head %}
<style>
@font-face {
    font-family: 'Astronomicon';
    src: url('{{ site.base_path }}/static/fonts/Astronomicon.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
}

:root {
    --natal-primary: #6366f1;
    --natal-primary-light: #818cf8;
    --natal-surface: #ffffff;
    --natal-bg: #f8fafc;
    --natal-text: #1e293b;
    --natal-text-secondary: #64748b;
    --natal-border: #e2e8f0;
    --natal-success: #22c55e;
    --natal-error: #ef4444;
}

@media (prefers-color-scheme: dark) {
    :root {
        --natal-surface: #1e293b;
        --natal-bg: #0f172a;
        --natal-text: #f1f5f9;
        --natal-text-secondary: #94a3b8;
        --natal-border: #334155;
    }
}

.main-content {
    padding: 0 !important;
    max-width: none !important;
    margin: 0 !important;
}

.natal-container {
    min-height: calc(100vh - 120px);
    padding: 24px;
    background: var(--natal-bg);
}

.natal-header {
    text-align: center;
    margin-bottom: 32px;
}

.natal-title {
    font-size: 28px;
    font-weight: 600;
    color: var(--natal-text);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.natal-title-icon {
    font-family: "Noto Sans Symbols 2", sans-serif;
    font-variant-emoji: text;
}

.natal-subtitle {
    color: var(--natal-text-secondary);
    font-size: 14px;
}

.natal-content {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 24px;
}

@media (max-width: 900px) {
    .natal-content {
        grid-template-columns: 1fr;
    }
}

/* Input Panel */
.input-panel {
    background: var(--natal-surface);
    border-radius: 12px;
    padding: 24px;
    border: 1px solid var(--natal-border);
}

.input-section {
    margin-bottom: 20px;
}

.input-section:last-child {
    margin-bottom: 0;
}

.input-label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--natal-text-secondary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.input-row {
    display: flex;
    gap: 12px;
}

.input-field {
    flex: 1;
    padding: 12px 14px;
    border: 1px solid var(--natal-border);
    border-radius: 8px;
    font-size: 15px;
    background: var(--natal-bg);
    color: var(--natal-text);
    transition: border-color 0.2s;
}

.input-field:focus {
    outline: none;
    border-color: var(--natal-primary);
}

.input-field::placeholder {
    color: var(--natal-text-secondary);
}

/* City Search */
.city-search-container {
    position: relative;
}

.city-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--natal-surface);
    border: 1px solid var(--natal-border);
    border-radius: 8px;
    margin-top: 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    display: none;
}

.city-suggestions.active {
    display: block;
}

.city-suggestion {
    padding: 12px 14px;
    cursor: pointer;
    font-size: 14px;
    color: var(--natal-text);
    border-bottom: 1px solid var(--natal-border);
}

.city-suggestion:last-child {
    border-bottom: none;
}

.city-suggestion:hover {
    background: var(--natal-bg);
}

.city-suggestion-name {
    font-weight: 500;
}

.city-suggestion-detail {
    font-size: 12px;
    color: var(--natal-text-secondary);
    margin-top: 2px;
}

/* House System Select */
.house-select {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid var(--natal-border);
    border-radius: 8px;
    font-size: 15px;
    background: var(--natal-bg);
    color: var(--natal-text);
    cursor: pointer;
}

/* Planet Selection */
.planet-selection {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--natal-border);
}

.planet-group {
    margin-bottom: 16px;
}

.planet-group-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--natal-text-secondary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.planet-checkboxes {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.planet-checkbox {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--natal-bg);
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    color: var(--natal-text);
    transition: background 0.2s;
}

.planet-checkbox:hover {
    background: var(--natal-border);
}

.planet-checkbox input {
    margin: 0;
    cursor: pointer;
}

.planet-checkbox .planet-symbol {
    font-family: 'Astronomicon', sans-serif;
    font-size: 14px;
}

/* Result Panel */
.result-panel {
    background: var(--natal-surface);
    border-radius: 12px;
    padding: 24px;
    border: 1px solid var(--natal-border);
    position: relative;
}

.result-placeholder {
    text-align: center;
    padding: 60px 20px;
    color: var(--natal-text-secondary);
}

.result-placeholder-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
    font-family: "Noto Sans Symbols 2", sans-serif;
    font-variant-emoji: text;
}

/* Update Indicator */
.update-indicator {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 8px;
    height: 8px;
    background: var(--natal-primary);
    border-radius: 50%;
    animation: pulse 1s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.2); }
}

/* Chart Container */
#natal-chart {
    width: 100%;
    max-width: 500px;
    margin: 0 auto 24px;
}

#natal-chart svg {
    width: 100%;
    height: auto;
}

/* Info Tables */
.info-tables {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.info-table {
    background: var(--natal-bg);
    border-radius: 8px;
    overflow: hidden;
}

.info-table-title {
    padding: 12px 16px;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--natal-text-secondary);
    border-bottom: 1px solid var(--natal-border);
}

.info-table table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.info-table th,
.info-table td {
    padding: 10px 16px;
    text-align: left;
    border-bottom: 1px solid var(--natal-border);
}

.info-table th {
    font-weight: 500;
    color: var(--natal-text-secondary);
    font-size: 12px;
    text-transform: uppercase;
}

.info-table td {
    color: var(--natal-text);
}

.info-table tr:last-child td {
    border-bottom: none;
}

.planet-symbol {
    font-family: 'Astronomicon', sans-serif;
    font-size: 16px;
}

.retrograde {
    color: var(--natal-error);
    font-size: 11px;
    margin-left: 4px;
}

/* Loading State */
.loading {
    text-align: center;
    padding: 40px;
    color: var(--natal-text-secondary);
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--natal-border);
    border-top-color: var(--natal-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Error State */
.error-message {
    background: #fef2f2;
    color: #dc2626;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    margin-top: 12px;
}

@media (prefers-color-scheme: dark) {
    .error-message {
        background: #450a0a;
        color: #fca5a5;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="natal-container">
    <header class="natal-header">
        <h1 class="natal-title">
            <span class="natal-title-icon">&#x2726;</span>
            本命星盘
        </h1>
        <p class="natal-subtitle">实时生成您的专属本命星盘</p>
    </header>

    <div class="natal-content">
        <aside class="input-panel">
            <div class="input-section">
                <label class="input-label">出生日期</label>
                <div class="input-row">
                    <input type="number" id="birth-year" class="input-field" placeholder="年" min="1800" max="2400">
                    <input type="number" id="birth-month" class="input-field" placeholder="月" min="1" max="12">
                    <input type="number" id="birth-day" class="input-field" placeholder="日" min="1" max="31">
                </div>
            </div>

            <div class="input-section">
                <label class="input-label">出生时间</label>
                <div class="input-row">
                    <input type="number" id="birth-hour" class="input-field" placeholder="时" min="0" max="23">
                    <input type="number" id="birth-minute" class="input-field" placeholder="分" min="0" max="59">
                </div>
            </div>

            <div class="input-section">
                <label class="input-label">时区</label>
                <select id="timezone" class="house-select">
                    <option value="-12">UTC-12</option>
                    <option value="-11">UTC-11</option>
                    <option value="-10">UTC-10 (夏威夷)</option>
                    <option value="-9">UTC-9 (阿拉斯加)</option>
                    <option value="-8">UTC-8 (太平洋时间)</option>
                    <option value="-7">UTC-7 (山地时间)</option>
                    <option value="-6">UTC-6 (中部时间)</option>
                    <option value="-5">UTC-5 (东部时间)</option>
                    <option value="-4">UTC-4</option>
                    <option value="-3">UTC-3 (巴西)</option>
                    <option value="-2">UTC-2</option>
                    <option value="-1">UTC-1</option>
                    <option value="0">UTC+0 (英国/格林尼治)</option>
                    <option value="1">UTC+1 (中欧)</option>
                    <option value="2">UTC+2 (东欧)</option>
                    <option value="3">UTC+3 (莫斯科)</option>
                    <option value="4">UTC+4 (迪拜)</option>
                    <option value="5">UTC+5 (巴基斯坦)</option>
                    <option value="5.5">UTC+5:30 (印度)</option>
                    <option value="6">UTC+6 (孟加拉)</option>
                    <option value="7">UTC+7 (泰国/越南)</option>
                    <option value="8" selected>UTC+8 (中国/新加坡/台湾)</option>
                    <option value="9">UTC+9 (日本/韩国)</option>
                    <option value="10">UTC+10 (澳大利亚东部)</option>
                    <option value="11">UTC+11</option>
                    <option value="12">UTC+12 (新西兰)</option>
                </select>
            </div>

            <div class="input-section">
                <label class="input-label">出生地点</label>
                <div class="city-search-container">
                    <input type="text" id="birth-city" class="input-field" placeholder="搜索城市..." autocomplete="off">
                    <div id="city-suggestions" class="city-suggestions"></div>
                </div>
                <input type="hidden" id="birth-lat">
                <input type="hidden" id="birth-lon">
            </div>

            <div class="input-section">
                <label class="input-label">宫位制</label>
                <select id="house-system" class="house-select">
                    <option value="P">Placidus (默认)</option>
                    <option value="K">Koch</option>
                    <option value="W">整宫制 (Whole Sign)</option>
                    <option value="E">等宫制 (Equal)</option>
                    <option value="R">Regiomontanus</option>
                    <option value="C">Campanus</option>
                </select>
            </div>

            <div class="planet-selection">
                <label class="input-label">显示天体</label>
                <div class="planet-group">
                    <div class="planet-group-title">主要行星</div>
                    <div class="planet-checkboxes" id="main-planets"></div>
                </div>
                <div class="planet-group">
                    <div class="planet-group-title">小行星和特殊点</div>
                    <div class="planet-checkboxes" id="minor-planets"></div>
                </div>
            </div>

            <div id="error-container"></div>
        </aside>

        <main class="result-panel">
            <div id="update-indicator" class="update-indicator" style="display: none;"></div>
            <div id="result-content">
                <div class="result-placeholder">
                    <div class="result-placeholder-icon">&#x2726;</div>
                    <p>正在加载星盘...</p>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ site.base_path }}/static/js/astrochart2.js"></script>
<script src="{{ site.base_path }}/static/js/astro-sweph.js"></script>
<script>
(function() {
    'use strict';

    // DOM Elements
    const birthYear = document.getElementById('birth-year');
    const birthMonth = document.getElementById('birth-month');
    const birthDay = document.getElementById('birth-day');
    const birthHour = document.getElementById('birth-hour');
    const birthMinute = document.getElementById('birth-minute');
    const timezone = document.getElementById('timezone');
    const birthCity = document.getElementById('birth-city');
    const birthLat = document.getElementById('birth-lat');
    const birthLon = document.getElementById('birth-lon');
    const houseSystem = document.getElementById('house-system');
    const resultContent = document.getElementById('result-content');
    const citySuggestions = document.getElementById('city-suggestions');
    const errorContainer = document.getElementById('error-container');
    const updateIndicator = document.getElementById('update-indicator');
    const mainPlanetsContainer = document.getElementById('main-planets');
    const minorPlanetsContainer = document.getElementById('minor-planets');

    // Planet definitions
    const CELESTIAL_BODIES = {
        main: [
            { id: 'Sun', cn: '太阳', symbol: 'Q', default: true },
            { id: 'Moon', cn: '月亮', symbol: 'R', default: true },
            { id: 'Mercury', cn: '水星', symbol: 'S', default: true },
            { id: 'Venus', cn: '金星', symbol: 'T', default: true },
            { id: 'Mars', cn: '火星', symbol: 'U', default: true },
            { id: 'Jupiter', cn: '木星', symbol: 'V', default: true },
            { id: 'Saturn', cn: '土星', symbol: 'W', default: true },
            { id: 'Uranus', cn: '天王星', symbol: 'X', default: true },
            { id: 'Neptune', cn: '海王星', symbol: 'Y', default: true },
            { id: 'Pluto', cn: '冥王星', symbol: 'Z', default: true }
        ],
        minor: [
            { id: 'Chiron', cn: '凯龙星', symbol: 'q', default: false },
            { id: 'Lilith', cn: '莉莉丝', symbol: 'z', default: false },
            { id: 'NNode', cn: '北交点', symbol: '[', default: false },
            { id: 'SNode', cn: '南交点', symbol: ']', default: false }
        ]
    };

    const SIGNS = ['白羊', '金牛', '双子', '巨蟹', '狮子', '处女', '天秤', '天蝎', '射手', '摩羯', '水瓶', '双鱼'];

    // Selected planets state
    let selectedPlanets = {};

    // Initialize planet checkboxes
    function initPlanetCheckboxes() {
        const saved = localStorage.getItem('natal-chart-planets');
        if (saved) {
            try {
                selectedPlanets = JSON.parse(saved);
            } catch (e) {
                selectedPlanets = {};
            }
        }

        // Main planets
        mainPlanetsContainer.innerHTML = CELESTIAL_BODIES.main.map(p => {
            const checked = selectedPlanets[p.id] !== undefined ? selectedPlanets[p.id] : p.default;
            selectedPlanets[p.id] = checked;
            return `
                <label class="planet-checkbox">
                    <input type="checkbox" data-planet="${p.id}" ${checked ? 'checked' : ''}>
                    <span class="planet-symbol">${p.symbol}</span>
                    ${p.cn}
                </label>
            `;
        }).join('');

        // Minor planets
        minorPlanetsContainer.innerHTML = CELESTIAL_BODIES.minor.map(p => {
            const checked = selectedPlanets[p.id] !== undefined ? selectedPlanets[p.id] : p.default;
            selectedPlanets[p.id] = checked;
            return `
                <label class="planet-checkbox">
                    <input type="checkbox" data-planet="${p.id}" ${checked ? 'checked' : ''}>
                    <span class="planet-symbol">${p.symbol}</span>
                    ${p.cn}
                </label>
            `;
        }).join('');

        // Add event listeners
        document.querySelectorAll('.planet-checkbox input').forEach(cb => {
            cb.addEventListener('change', function() {
                selectedPlanets[this.dataset.planet] = this.checked;
                localStorage.setItem('natal-chart-planets', JSON.stringify(selectedPlanets));
                scheduleUpdate();
            });
        });
    }

    // Convert local time to UTC based on timezone offset
    function localToUTC(year, month, day, hour, minute, tzOffset) {
        let utcHour = hour - tzOffset;
        let utcDay = day;
        let utcMonth = month;
        let utcYear = year;

        if (utcHour < 0) {
            utcHour += 24;
            utcDay -= 1;
        } else if (utcHour >= 24) {
            utcHour -= 24;
            utcDay += 1;
        }

        const daysInMonth = new Date(utcYear, utcMonth, 0).getDate();
        if (utcDay < 1) {
            utcMonth -= 1;
            if (utcMonth < 1) {
                utcMonth = 12;
                utcYear -= 1;
            }
            utcDay = new Date(utcYear, utcMonth, 0).getDate();
        } else if (utcDay > daysInMonth) {
            utcDay = 1;
            utcMonth += 1;
            if (utcMonth > 12) {
                utcMonth = 1;
                utcYear += 1;
            }
        }

        return { year: utcYear, month: utcMonth, day: utcDay, hour: utcHour, minute };
    }

    // Format timezone for display
    function formatTimezone(offset) {
        const sign = offset >= 0 ? '+' : '';
        if (offset % 1 !== 0) {
            const hours = Math.floor(Math.abs(offset));
            const mins = (Math.abs(offset) % 1) * 60;
            return `UTC${sign}${Math.sign(offset) * hours}:${mins.toString().padStart(2, '0')}`;
        }
        return `UTC${sign}${offset}`;
    }

    // Detect browser timezone offset
    function detectTimezone() {
        const offset = -new Date().getTimezoneOffset() / 60;
        // Find closest option
        const options = Array.from(timezone.options);
        let closest = options[0];
        let minDiff = Infinity;
        options.forEach(opt => {
            const diff = Math.abs(parseFloat(opt.value) - offset);
            if (diff < minDiff) {
                minDiff = diff;
                closest = opt;
            }
        });
        return closest.value;
    }

    // Fill current date/time
    function fillCurrentDateTime() {
        const now = new Date();
        birthYear.value = now.getFullYear();
        birthMonth.value = now.getMonth() + 1;
        birthDay.value = now.getDate();
        birthHour.value = now.getHours();
        birthMinute.value = now.getMinutes();
        timezone.value = detectTimezone();
    }

    // Get location by IP
    async function getLocationByIP() {
        try {
            const response = await fetch('https://ip-api.com/json/?fields=lat,lon,city,timezone');
            const data = await response.json();
            if (data.lat && data.lon) {
                birthLat.value = data.lat;
                birthLon.value = data.lon;
                birthCity.value = data.city || '当前位置';
                return true;
            }
        } catch (e) {
            console.log('IP location failed, using default');
        }
        // Fallback to Beijing
        birthLat.value = 39.9042;
        birthLon.value = 116.4074;
        birthCity.value = '北京';
        return false;
    }

    // City search with debounce
    let searchTimeout;
    birthCity.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
            citySuggestions.classList.remove('active');
            return;
        }

        searchTimeout = setTimeout(() => searchCity(query), 300);
    });

    async function searchCity(query) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&addressdetails=1`,
                { headers: { 'Accept-Language': 'zh,en' } }
            );
            const results = await response.json();

            if (results.length === 0) {
                citySuggestions.innerHTML = '<div class="city-suggestion"><div class="city-suggestion-name">未找到结果</div></div>';
            } else {
                citySuggestions.innerHTML = results.map(r => `
                    <div class="city-suggestion" data-lat="${r.lat}" data-lon="${r.lon}" data-name="${r.display_name.split(',')[0]}">
                        <div class="city-suggestion-name">${r.display_name.split(',')[0]}</div>
                        <div class="city-suggestion-detail">${r.display_name}</div>
                    </div>
                `).join('');
            }
            citySuggestions.classList.add('active');
        } catch (error) {
            console.error('City search error:', error);
        }
    }

    citySuggestions.addEventListener('click', function(e) {
        const suggestion = e.target.closest('.city-suggestion');
        if (suggestion && suggestion.dataset.lat) {
            birthCity.value = suggestion.dataset.name;
            birthLat.value = suggestion.dataset.lat;
            birthLon.value = suggestion.dataset.lon;
            citySuggestions.classList.remove('active');
            scheduleUpdate();
        }
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.city-search-container')) {
            citySuggestions.classList.remove('active');
        }
    });

    // Debounced chart update
    let updateTimeout;
    function scheduleUpdate() {
        clearTimeout(updateTimeout);
        updateIndicator.style.display = 'block';
        updateTimeout = setTimeout(() => {
            generateChart();
            updateIndicator.style.display = 'none';
        }, 500);
    }

    // Generate chart
    async function generateChart() {
        const year = parseInt(birthYear.value);
        const month = parseInt(birthMonth.value);
        const day = parseInt(birthDay.value);
        const hour = parseInt(birthHour.value) || 12;
        const minute = parseInt(birthMinute.value) || 0;
        const lat = parseFloat(birthLat.value);
        const lon = parseFloat(birthLon.value);
        const tzOffset = parseFloat(timezone.value);

        if (!year || !month || !day) {
            return; // Silent fail for incomplete data
        }

        if (isNaN(lat) || isNaN(lon)) {
            return; // Silent fail for missing location
        }

        clearError();

        try {
            if (typeof Module === 'undefined' || !Module._get) {
                resultContent.innerHTML = `
                    <div class="result-placeholder">
                        <div class="result-placeholder-icon">&#x2726;</div>
                        <p>星历计算模块加载中...</p>
                    </div>
                `;
                return;
            }

            const utc = localToUTC(year, month, day, hour, minute, tzOffset);

            const lonDeg = Math.floor(Math.abs(lon));
            const lonMin = Math.floor((Math.abs(lon) - lonDeg) * 60);
            const lonSec = Math.round(((Math.abs(lon) - lonDeg) * 60 - lonMin) * 60);
            const lonDir = lon >= 0 ? 'E' : 'W';

            const latDeg = Math.floor(Math.abs(lat));
            const latMin = Math.floor((Math.abs(lat) - latDeg) * 60);
            const latSec = Math.round(((Math.abs(lat) - latDeg) * 60 - latMin) * 60);
            const latDir = lat >= 0 ? 'N' : 'S';

            const hsys = houseSystem.value;

            const resultPtr = Module._get(
                utc.year, utc.month, utc.day, utc.hour, utc.minute, 0,
                lonDeg, lonMin, lonSec, lonDir,
                latDeg, latMin, latSec, latDir,
                hsys
            );

            const resultStr = Module.UTF8ToString(resultPtr);
            const chartData = JSON.parse(resultStr);

            if (chartData.error) {
                throw new Error(chartData.error_msg || '计算错误');
            }

            renderChart(chartData, {
                local: { year, month, day, hour, minute },
                utc: utc,
                timezone: tzOffset
            });

        } catch (error) {
            console.error('Chart generation error:', error);
            showError(error.message || '生成星盘时发生错误');
        }
    }

    function renderChart(data, birthInfo) {
        let planetsData = data.planets || data.body || data.bodies || [];
        let housesData = data.house || data.houses || data.cusps || [];

        if (!Array.isArray(planetsData) || planetsData.length === 0) {
            throw new Error('未找到行星数据');
        }

        // Debug: log all planet names from WASM
        console.log('WASM returned planets:', planetsData.map(p => p.name));

        // Name mapping from Swiss Ephemeris to our IDs
        const NAME_MAP = {
            'Mean Node': 'NNode',
            'True Node': 'NNode',
            'mean Node': 'NNode',
            'North Node': 'NNode',
            'Mean Apogee': 'Lilith',
            'mean Apogee': 'Lilith',
            'Black Moon': 'Lilith'
        };

        // Map planet names and add South Node
        const mappedPlanets = [];
        planetsData.forEach(p => {
            const mappedName = NAME_MAP[p.name] || p.name;
            mappedPlanets.push({ ...p, name: mappedName });

            // Calculate South Node as opposite of North Node
            if (mappedName === 'NNode') {
                const lon = p.lon !== undefined ? p.lon : p.long;
                mappedPlanets.push({
                    name: 'SNode',
                    lon: (lon + 180) % 360,
                    speed: p.speed
                });
            }
        });

        // Get list of enabled planet IDs
        const enabledPlanetIds = Object.keys(selectedPlanets).filter(id => selectedPlanets[id] === true);

        // Filter planets based on selection (match by name)
        const filteredPlanets = mappedPlanets.filter(p => enabledPlanetIds.includes(p.name));

        const points = filteredPlanets.map(p => ({
            name: p.name,
            angle: p.lon !== undefined ? p.lon : p.long,
            isRetrograde: p.speed < 0
        }));

        const cusps = housesData.map(c => ({ angle: c.lon !== undefined ? c.lon : c.long }));

        const localTimeStr = `${birthInfo.local.year}年${birthInfo.local.month}月${birthInfo.local.day}日 ${String(birthInfo.local.hour).padStart(2, '0')}:${String(birthInfo.local.minute).padStart(2, '0')}`;
        const utcTimeStr = `${birthInfo.utc.year}年${birthInfo.utc.month}月${birthInfo.utc.day}日 ${String(birthInfo.utc.hour).padStart(2, '0')}:${String(birthInfo.utc.minute).padStart(2, '0')}`;
        const tzStr = formatTimezone(birthInfo.timezone);

        resultContent.innerHTML = `
            <div class="time-info" style="text-align: center; margin-bottom: 20px; padding: 16px; background: var(--natal-bg); border-radius: 8px; font-size: 14px;">
                <div style="margin-bottom: 8px;"><strong>本地时间:</strong> ${localTimeStr} (${tzStr})</div>
                <div style="color: var(--natal-text-secondary);"><strong>UTC时间:</strong> ${utcTimeStr}</div>
            </div>
            <div id="natal-chart"></div>
            <div class="info-tables">
                <div class="info-table">
                    <div class="info-table-title">行星位置</div>
                    <table>
                        <thead>
                            <tr>
                                <th>天体</th>
                                <th>星座</th>
                                <th>度数</th>
                                <th>宫位</th>
                            </tr>
                        </thead>
                        <tbody id="planets-table"></tbody>
                    </table>
                </div>
                <div class="info-table">
                    <div class="info-table-title">宫头位置</div>
                    <table>
                        <thead>
                            <tr>
                                <th>宫位</th>
                                <th>星座</th>
                                <th>度数</th>
                            </tr>
                        </thead>
                        <tbody id="houses-table"></tbody>
                    </table>
                </div>
            </div>
        `;

        // Custom aspects with proper orbs
        const ASPECTS = [
            { name: 'Conjunction', angle: 0, orb: 8 },
            { name: 'Opposition', angle: 180, orb: 8 },
            { name: 'Trine', angle: 120, orb: 8 },
            { name: 'Square', angle: 90, orb: 8 },
            { name: 'Sextile', angle: 60, orb: 6 },
            { name: 'Quincunx', angle: 150, orb: 3 }
        ];

        try {
            // Clear any existing chart content before rendering
            const chartContainer = document.getElementById('natal-chart');
            if (chartContainer) {
                chartContainer.innerHTML = '';
            }
            const chart = new astrology.Universe('natal-chart');
            chart.radix().setData({ points, cusps });
            chart.radix().drawAspects(points, points, ASPECTS);
        } catch (e) {
            console.error('Chart render error:', e);
        }

        const planetsTable = document.getElementById('planets-table');
        planetsTable.innerHTML = filteredPlanets.map(p => {
            const pLong = p.lon !== undefined ? p.lon : p.long;
            const signIndex = Math.floor(pLong / 30);
            const degInSign = pLong % 30;
            const deg = Math.floor(degInSign);
            const min = Math.floor((degInSign - deg) * 60);
            const house = getHouse(pLong, housesData);
            const retrograde = p.speed < 0 ? '<span class="retrograde">R</span>' : '';

            return `
                <tr>
                    <td><span class="planet-symbol">${getPlanetSymbol(p.name)}</span> ${getPlanetCN(p.name)}${retrograde}</td>
                    <td>${SIGNS[signIndex]}</td>
                    <td>${deg}°${min}'</td>
                    <td>${house}宫</td>
                </tr>
            `;
        }).join('');

        const housesTable = document.getElementById('houses-table');
        housesTable.innerHTML = housesData.map((c, i) => {
            const cLong = c.lon !== undefined ? c.lon : c.long;
            const signIndex = Math.floor(cLong / 30);
            const degInSign = cLong % 30;
            const deg = Math.floor(degInSign);
            const min = Math.floor((degInSign - deg) * 60);
            const houseNames = ['', 'ASC', '', '', 'IC', '', '', 'DSC', '', '', 'MC', '', ''];
            const label = houseNames[i + 1] ? ` (${houseNames[i + 1]})` : '';

            return `
                <tr>
                    <td>${i + 1}宫${label}</td>
                    <td>${SIGNS[signIndex]}</td>
                    <td>${deg}°${min}'</td>
                </tr>
            `;
        }).join('');
    }

    function getHouse(planetLong, cusps) {
        for (let i = 0; i < 12; i++) {
            const nextI = (i + 1) % 12;
            const c = cusps[i];
            const nc = cusps[nextI];
            let start = c.lon !== undefined ? c.lon : c.long;
            let end = nc.lon !== undefined ? nc.lon : nc.long;

            if (end < start) end += 360;
            let pLong = planetLong;
            if (pLong < start) pLong += 360;

            if (pLong >= start && pLong < end) {
                return i + 1;
            }
        }
        return 1;
    }

    function getPlanetSymbol(name) {
        const all = [...CELESTIAL_BODIES.main, ...CELESTIAL_BODIES.minor];
        const found = all.find(p => p.id === name);
        return found ? found.symbol : '';
    }

    function getPlanetCN(name) {
        const all = [...CELESTIAL_BODIES.main, ...CELESTIAL_BODIES.minor];
        const found = all.find(p => p.id === name);
        return found ? found.cn : name;
    }

    function showError(message) {
        errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
    }

    function clearError() {
        errorContainer.innerHTML = '';
    }

    // Load saved data from localStorage
    function loadSavedData() {
        const saved = localStorage.getItem('natal-chart-input');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                if (data.year) birthYear.value = data.year;
                if (data.month) birthMonth.value = data.month;
                if (data.day) birthDay.value = data.day;
                if (data.hour) birthHour.value = data.hour;
                if (data.minute) birthMinute.value = data.minute;
                if (data.timezone !== undefined) timezone.value = data.timezone;
                if (data.city) birthCity.value = data.city;
                if (data.lat) birthLat.value = data.lat;
                if (data.lon) birthLon.value = data.lon;
                return true;
            } catch (e) {}
        }
        return false;
    }

    // Save data on input change
    function saveData() {
        const data = {
            year: birthYear.value,
            month: birthMonth.value,
            day: birthDay.value,
            hour: birthHour.value,
            minute: birthMinute.value,
            timezone: timezone.value,
            city: birthCity.value,
            lat: birthLat.value,
            lon: birthLon.value
        };
        localStorage.setItem('natal-chart-input', JSON.stringify(data));
    }

    // Add input event listeners for real-time updates
    [birthYear, birthMonth, birthDay, birthHour, birthMinute, timezone, houseSystem].forEach(el => {
        el.addEventListener('input', () => {
            saveData();
            scheduleUpdate();
        });
        el.addEventListener('change', () => {
            saveData();
            scheduleUpdate();
        });
    });

    // Initialize
    async function init() {
        initPlanetCheckboxes();

        const hasSavedData = loadSavedData();

        if (!hasSavedData) {
            fillCurrentDateTime();
            await getLocationByIP();
        }

        // Wait for WASM module to load, then generate chart
        const checkModule = setInterval(() => {
            if (typeof Module !== 'undefined' && Module._get) {
                clearInterval(checkModule);
                generateChart();
            }
        }, 100);

        // Timeout after 10 seconds
        setTimeout(() => clearInterval(checkModule), 10000);
    }

    init();
})();
</script>
{% endblock %}
