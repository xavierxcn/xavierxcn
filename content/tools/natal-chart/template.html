{% extends "base.html" %}

{% block title %}本命星盘 - {{ site.title }}{% endblock %}

{% block description %}输入出生日期、时间和地点，生成专业级本命星盘图，显示行星位置和相位{% endblock %}

{% block head %}
<!-- Google Fonts: Cormorant Garamond for display, Noto Serif SC for Chinese -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Noto+Serif+SC:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
@font-face {
    font-family: 'Astronomicon';
    src: url('{{ site.base_path }}/static/fonts/Astronomicon.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
}

/* ═══════════════════════════════════════════════════════════════
   CELESTIAL LIGHT THEME
   Refined, elegant light design for astrology
   ═══════════════════════════════════════════════════════════════ */

:root {
    /* Light color palette */
    --natal-bg: #faf9f7;
    --natal-surface: #ffffff;
    --natal-surface-alt: #f5f3f0;
    --natal-border: #e8e4de;
    --natal-border-strong: #d4cfc6;

    /* Accent colors - warm bronze/copper */
    --natal-accent: #8b6914;
    --natal-accent-light: #a67c00;
    --natal-accent-soft: rgba(139, 105, 20, 0.1);
    --natal-accent-glow: rgba(139, 105, 20, 0.15);

    /* Text colors */
    --natal-text: #2c2416;
    --natal-text-secondary: #6b5d4d;
    --natal-text-muted: #9a8d7c;

    /* Status colors */
    --natal-error: #c44536;
    --natal-success: #4a7c59;

    /* Typography */
    --font-display: 'Cormorant Garamond', serif;
    --font-body: 'Noto Serif SC', serif;

    /* Spacing */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;
    --space-2xl: 48px;

    /* Effects */
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.1);
}

/* ═══════════════════════════════════════════════════════════════
   BASE LAYOUT
   ═══════════════════════════════════════════════════════════════ */

.main-content {
    padding: 0 !important;
    max-width: none !important;
    margin: 0 !important;
}

.natal-container {
    min-height: calc(100vh - 120px);
    padding: var(--space-xl);
    background: var(--natal-bg);
    background-image:
        radial-gradient(ellipse at 30% 0%, rgba(139, 105, 20, 0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 100%, rgba(139, 105, 20, 0.02) 0%, transparent 50%);
}

/* ═══════════════════════════════════════════════════════════════
   HEADER
   ═══════════════════════════════════════════════════════════════ */

.natal-header {
    text-align: center;
    margin-bottom: var(--space-2xl);
}

.natal-title {
    font-family: var(--font-display);
    font-size: 2.8rem;
    font-weight: 400;
    color: var(--natal-text);
    margin-bottom: var(--space-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);
    letter-spacing: 0.05em;
}

.natal-title-icon {
    font-family: "Noto Sans Symbols 2", sans-serif;
    font-variant-emoji: text;
    color: var(--natal-accent);
}

.natal-subtitle {
    font-family: var(--font-body);
    color: var(--natal-text-secondary);
    font-size: 1rem;
    font-weight: 300;
    letter-spacing: 0.05em;
}

/* Decorative divider */
.natal-header::after {
    content: '';
    display: block;
    width: 60px;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--natal-border-strong), transparent);
    margin: var(--space-lg) auto 0;
}

/* ═══════════════════════════════════════════════════════════════
   CONTENT GRID
   ═══════════════════════════════════════════════════════════════ */

.natal-content {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 340px 1fr;
    gap: var(--space-xl);
}

@media (max-width: 900px) {
    .natal-content {
        grid-template-columns: 1fr;
        max-width: 600px;
    }
}

/* ═══════════════════════════════════════════════════════════════
   INPUT PANEL
   ═══════════════════════════════════════════════════════════════ */

.input-panel {
    background: var(--natal-surface);
    border-radius: 12px;
    padding: var(--space-lg);
    border: 1px solid var(--natal-border);
    box-shadow: var(--shadow-sm);
}

.input-section {
    margin-bottom: var(--space-lg);
}

.input-section:last-child {
    margin-bottom: 0;
}

.input-label {
    display: block;
    font-family: var(--font-display);
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--natal-text-secondary);
    margin-bottom: var(--space-sm);
    letter-spacing: 0.08em;
}

.input-row {
    display: flex;
    gap: var(--space-sm);
}

.input-field {
    flex: 1;
    padding: 12px 14px;
    border: 1px solid var(--natal-border);
    border-radius: 8px;
    font-family: var(--font-body);
    font-size: 0.95rem;
    background: var(--natal-surface);
    color: var(--natal-text);
    transition: all 0.2s ease;
}

.input-field:hover {
    border-color: var(--natal-border-strong);
}

.input-field:focus {
    outline: none;
    border-color: var(--natal-accent);
    box-shadow: 0 0 0 3px var(--natal-accent-soft);
}

.input-field::placeholder {
    color: var(--natal-text-muted);
}

/* Remove number input spinners */
.input-field[type="number"]::-webkit-outer-spin-button,
.input-field[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.input-field[type="number"] {
    -moz-appearance: textfield;
}

/* ═══════════════════════════════════════════════════════════════
   CITY SEARCH
   ═══════════════════════════════════════════════════════════════ */

.city-search-container {
    position: relative;
}

.city-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--natal-surface);
    border: 1px solid var(--natal-border);
    border-radius: 8px;
    margin-top: var(--space-xs);
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    box-shadow: var(--shadow-lg);
}

.city-suggestions.active {
    display: block;
}

.city-suggestion {
    padding: 12px 14px;
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 0.9rem;
    color: var(--natal-text);
    border-bottom: 1px solid var(--natal-border);
    transition: background 0.15s ease;
}

.city-suggestion:last-child {
    border-bottom: none;
}

.city-suggestion:hover {
    background: var(--natal-surface-alt);
}

.city-suggestion-name {
    font-weight: 500;
}

.city-suggestion-detail {
    font-size: 0.8rem;
    color: var(--natal-text-muted);
    margin-top: 2px;
}

/* ═══════════════════════════════════════════════════════════════
   COORDINATES DISPLAY
   ═══════════════════════════════════════════════════════════════ */

.coords-display {
    margin-top: var(--space-md);
    display: flex;
    gap: var(--space-lg);
    font-family: var(--font-body);
    font-size: 0.85rem;
    color: var(--natal-text-secondary);
}

.coords-display label {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.coords-display input {
    width: 90px;
    padding: 6px 10px;
    border: 1px solid var(--natal-border);
    border-radius: 6px;
    font-family: var(--font-body);
    font-size: 0.85rem;
    background: var(--natal-surface);
    color: var(--natal-text);
    transition: all 0.2s ease;
}

.coords-display input:focus {
    outline: none;
    border-color: var(--natal-accent);
    box-shadow: 0 0 0 2px var(--natal-accent-soft);
}

/* ═══════════════════════════════════════════════════════════════
   SELECT (House System)
   ═══════════════════════════════════════════════════════════════ */

.house-select {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid var(--natal-border);
    border-radius: 8px;
    font-family: var(--font-body);
    font-size: 0.95rem;
    background: var(--natal-surface);
    color: var(--natal-text);
    cursor: pointer;
    transition: all 0.2s ease;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b5d4d' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
    padding-right: 36px;
}

.house-select:hover {
    border-color: var(--natal-border-strong);
}

.house-select:focus {
    outline: none;
    border-color: var(--natal-accent);
    box-shadow: 0 0 0 3px var(--natal-accent-soft);
}

/* ═══════════════════════════════════════════════════════════════
   RESULT PANEL
   ═══════════════════════════════════════════════════════════════ */

.result-panel {
    background: var(--natal-surface);
    border-radius: 12px;
    padding: var(--space-xl);
    border: 1px solid var(--natal-border);
    box-shadow: var(--shadow-sm);
    position: relative;
    min-height: 500px;
}

.result-placeholder {
    text-align: center;
    padding: 80px 20px;
    color: var(--natal-text-muted);
}

.result-placeholder-icon {
    font-size: 56px;
    margin-bottom: var(--space-lg);
    color: var(--natal-border-strong);
    font-family: "Noto Sans Symbols 2", sans-serif;
    font-variant-emoji: text;
}

.result-placeholder p {
    font-family: var(--font-body);
    font-size: 1rem;
    font-weight: 300;
}

/* ═══════════════════════════════════════════════════════════════
   SETTINGS BUTTON
   ═══════════════════════════════════════════════════════════════ */

.settings-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 40px;
    height: 40px;
    border: 1px solid var(--natal-border);
    border-radius: 8px;
    background: var(--natal-surface);
    color: var(--natal-text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s ease;
    z-index: 10;
}

.settings-btn:hover {
    border-color: var(--natal-accent);
    color: var(--natal-accent);
    background: var(--natal-accent-soft);
}

/* ═══════════════════════════════════════════════════════════════
   UPDATE INDICATOR
   ═══════════════════════════════════════════════════════════════ */

.update-indicator {
    position: absolute;
    top: 24px;
    right: 64px;
    width: 8px;
    height: 8px;
    background: var(--natal-accent);
    border-radius: 50%;
    animation: pulse 1s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.2); }
}

/* ═══════════════════════════════════════════════════════════════
   SETTINGS MODAL
   ═══════════════════════════════════════════════════════════════ */

.settings-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(44, 36, 22, 0.3);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.settings-modal.active {
    display: flex;
}

.settings-modal-content {
    background: var(--natal-surface);
    border-radius: 12px;
    width: 400px;
    height: 520px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    border: 1px solid var(--natal-border);
    box-shadow: var(--shadow-lg);
}

.settings-modal-header {
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--natal-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.settings-modal-title {
    font-family: var(--font-display);
    font-size: 1.2rem;
    font-weight: 500;
    color: var(--natal-text);
    letter-spacing: 0.03em;
}

.settings-modal-close {
    width: 32px;
    height: 32px;
    border: none;
    background: none;
    color: var(--natal-text-muted);
    cursor: pointer;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.settings-modal-close:hover {
    background: var(--natal-surface-alt);
    color: var(--natal-text);
}

.settings-tabs {
    display: flex;
    border-bottom: 1px solid var(--natal-border);
    padding: 0 var(--space-lg);
}

.settings-tab {
    padding: 14px 20px;
    border: none;
    background: none;
    color: var(--natal-text-muted);
    cursor: pointer;
    font-family: var(--font-display);
    font-size: 0.95rem;
    font-weight: 500;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all 0.2s ease;
}

.settings-tab:hover {
    color: var(--natal-text-secondary);
}

.settings-tab.active {
    color: var(--natal-accent);
    border-bottom-color: var(--natal-accent);
}

.settings-body {
    padding: var(--space-lg);
    overflow-y: auto;
    flex: 1;
}

.settings-panel {
    display: none;
}

.settings-panel.active {
    display: block;
}

.settings-group {
    margin-bottom: var(--space-lg);
}

.settings-group:last-child {
    margin-bottom: 0;
}

.settings-group-title {
    font-family: var(--font-display);
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--natal-text-muted);
    margin-bottom: var(--space-md);
    letter-spacing: 0.05em;
}

.checkbox-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-sm);
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: 10px 12px;
    background: var(--natal-surface-alt);
    border: 1px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 0.9rem;
    color: var(--natal-text);
    transition: all 0.15s ease;
}

.checkbox-item:hover {
    border-color: var(--natal-border);
}

.checkbox-item:has(input:checked) {
    background: var(--natal-accent-soft);
    border-color: var(--natal-accent);
}

.checkbox-item input {
    margin: 0;
    cursor: pointer;
    accent-color: var(--natal-accent);
    width: 16px;
    height: 16px;
}

.checkbox-item .planet-symbol {
    font-family: 'Astronomicon', sans-serif;
    font-size: 15px;
    color: var(--natal-accent);
}

/* ═══════════════════════════════════════════════════════════════
   ASPECT ROWS
   ═══════════════════════════════════════════════════════════════ */

.aspect-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 14px;
    background: var(--natal-surface-alt);
    border: 1px solid transparent;
    border-radius: 8px;
    margin-bottom: var(--space-sm);
    transition: all 0.15s ease;
}

.aspect-row:hover {
    border-color: var(--natal-border);
}

.aspect-row:has(input[type="checkbox"]:checked) {
    background: var(--natal-accent-soft);
    border-color: var(--natal-accent);
}

.aspect-row:last-child {
    margin-bottom: 0;
}

.aspect-row-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.aspect-row-left input[type="checkbox"] {
    margin: 0;
    cursor: pointer;
    accent-color: var(--natal-accent);
    width: 16px;
    height: 16px;
}

.aspect-row-left label {
    font-family: var(--font-body);
    font-size: 0.9rem;
    color: var(--natal-text);
    cursor: pointer;
}

.aspect-row-right {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-body);
    font-size: 0.85rem;
    color: var(--natal-text-secondary);
}

.aspect-row-right input {
    width: 52px;
    padding: 6px 8px;
    border: 1px solid var(--natal-border);
    border-radius: 6px;
    font-family: var(--font-body);
    font-size: 0.85rem;
    text-align: center;
    background: var(--natal-surface);
    color: var(--natal-text);
    transition: all 0.2s ease;
}

.aspect-row-right input:focus {
    outline: none;
    border-color: var(--natal-accent);
    box-shadow: 0 0 0 2px var(--natal-accent-soft);
}

/* ═══════════════════════════════════════════════════════════════
   MODAL FOOTER
   ═══════════════════════════════════════════════════════════════ */

.settings-modal-footer {
    padding: var(--space-md) var(--space-lg);
    border-top: 1px solid var(--natal-border);
    display: flex;
    justify-content: flex-end;
    gap: var(--space-md);
    background: var(--natal-surface-alt);
}

.settings-modal-footer .btn-cancel {
    padding: 10px 20px;
    border: 1px solid var(--natal-border);
    border-radius: 8px;
    background: var(--natal-surface);
    color: var(--natal-text-secondary);
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.settings-modal-footer .btn-cancel:hover {
    border-color: var(--natal-border-strong);
    color: var(--natal-text);
}

.settings-modal-footer .btn-confirm {
    padding: 10px 24px;
    border: none;
    border-radius: 8px;
    background: var(--natal-accent);
    color: #fff;
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.settings-modal-footer .btn-confirm:hover {
    background: var(--natal-accent-light);
}

.reset-btn {
    padding: 8px 16px;
    border: 1px solid var(--natal-border);
    border-radius: 6px;
    background: var(--natal-surface);
    color: var(--natal-text-secondary);
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 0.85rem;
    margin-top: var(--space-md);
    transition: all 0.2s ease;
}

.reset-btn:hover {
    border-color: var(--natal-border-strong);
    color: var(--natal-text);
}

/* ═══════════════════════════════════════════════════════════════
   CHART CONTAINER
   ═══════════════════════════════════════════════════════════════ */

#natal-chart {
    width: 100%;
    max-width: 500px;
    margin: 0 auto var(--space-xl);
}

#natal-chart svg {
    width: 100%;
    height: auto;
}

/* Time info styling */
.time-info {
    text-align: center;
    margin-bottom: var(--space-lg) !important;
    padding: var(--space-md) var(--space-lg) !important;
    background: var(--natal-surface-alt) !important;
    border: 1px solid var(--natal-border) !important;
    border-radius: 10px !important;
    font-family: var(--font-body) !important;
    font-size: 0.9rem !important;
}

.time-info div:first-child {
    color: var(--natal-text) !important;
    font-weight: 500 !important;
}

.time-info div:last-child {
    color: var(--natal-text-secondary) !important;
}

/* ═══════════════════════════════════════════════════════════════
   INFO TABLES
   ═══════════════════════════════════════════════════════════════ */

.info-tables {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-lg);
}

.info-table {
    background: var(--natal-surface-alt);
    border: 1px solid var(--natal-border);
    border-radius: 10px;
    overflow: hidden;
}

.info-table-title {
    padding: 14px 18px;
    font-family: var(--font-display);
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--natal-text);
    background: var(--natal-surface);
    border-bottom: 1px solid var(--natal-border);
}

.info-table table {
    width: 100%;
    border-collapse: collapse;
    font-family: var(--font-body);
    font-size: 0.9rem;
}

.info-table th,
.info-table td {
    padding: 12px 18px;
    text-align: left;
    border-bottom: 1px solid var(--natal-border);
}

.info-table th {
    font-weight: 500;
    color: var(--natal-text-muted);
    font-size: 0.8rem;
    background: var(--natal-surface);
}

.info-table td {
    color: var(--natal-text);
    background: var(--natal-surface);
}

.info-table tr:last-child td {
    border-bottom: none;
}

.info-table tr:hover td {
    background: var(--natal-surface-alt);
}

.planet-symbol {
    font-family: 'Astronomicon', sans-serif;
    font-size: 17px;
    color: var(--natal-accent);
}

.retrograde {
    color: var(--natal-error);
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 4px;
    vertical-align: super;
}

/* ═══════════════════════════════════════════════════════════════
   LOADING & ERROR STATES
   ═══════════════════════════════════════════════════════════════ */

.loading {
    text-align: center;
    padding: 60px;
    color: var(--natal-text-secondary);
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 2px solid var(--natal-border);
    border-top-color: var(--natal-accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto var(--space-lg);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.error-message {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: var(--natal-error);
    padding: 14px 18px;
    border-radius: 8px;
    font-family: var(--font-body);
    font-size: 0.9rem;
    margin-top: var(--space-md);
}

/* ═══════════════════════════════════════════════════════════════
   RESPONSIVE ADJUSTMENTS
   ═══════════════════════════════════════════════════════════════ */

@media (max-width: 640px) {
    .natal-container {
        padding: var(--space-md);
    }

    .natal-title {
        font-size: 2rem;
    }

    .input-panel,
    .result-panel {
        padding: var(--space-md);
    }

    .settings-modal-content {
        width: 95%;
        max-width: 400px;
        height: 80vh;
        max-height: 520px;
    }

    .checkbox-grid {
        grid-template-columns: 1fr;
    }

    .aspect-row {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-sm);
    }

    .aspect-row-right {
        width: 100%;
        justify-content: flex-end;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="natal-container">
    <header class="natal-header">
        <h1 class="natal-title">
            <span class="natal-title-icon">&#x2726;</span>
            本命星盘
        </h1>
        <p class="natal-subtitle">实时生成您的专属本命星盘</p>
    </header>

    <div class="natal-content">
        <aside class="input-panel">
            <div class="input-section">
                <label class="input-label">出生日期</label>
                <div class="input-row">
                    <input type="number" id="birth-year" class="input-field" placeholder="年" min="1800" max="2400">
                    <input type="number" id="birth-month" class="input-field" placeholder="月" min="1" max="12">
                    <input type="number" id="birth-day" class="input-field" placeholder="日" min="1" max="31">
                </div>
            </div>

            <div class="input-section">
                <label class="input-label">出生时间</label>
                <div class="input-row">
                    <input type="number" id="birth-hour" class="input-field" placeholder="时" min="0" max="23">
                    <input type="number" id="birth-minute" class="input-field" placeholder="分" min="0" max="59">
                </div>
            </div>

            <div class="input-section">
                <label class="input-label">时区</label>
                <select id="timezone" class="house-select">
                    <option value="-12">UTC-12</option>
                    <option value="-11">UTC-11</option>
                    <option value="-10">UTC-10 (夏威夷)</option>
                    <option value="-9">UTC-9 (阿拉斯加)</option>
                    <option value="-8">UTC-8 (太平洋时间)</option>
                    <option value="-7">UTC-7 (山地时间)</option>
                    <option value="-6">UTC-6 (中部时间)</option>
                    <option value="-5">UTC-5 (东部时间)</option>
                    <option value="-4">UTC-4</option>
                    <option value="-3">UTC-3 (巴西)</option>
                    <option value="-2">UTC-2</option>
                    <option value="-1">UTC-1</option>
                    <option value="0">UTC+0 (英国/格林尼治)</option>
                    <option value="1">UTC+1 (中欧)</option>
                    <option value="2">UTC+2 (东欧)</option>
                    <option value="3">UTC+3 (莫斯科)</option>
                    <option value="4">UTC+4 (迪拜)</option>
                    <option value="5">UTC+5 (巴基斯坦)</option>
                    <option value="5.5">UTC+5:30 (印度)</option>
                    <option value="6">UTC+6 (孟加拉)</option>
                    <option value="7">UTC+7 (泰国/越南)</option>
                    <option value="8" selected>UTC+8 (中国/新加坡/台湾)</option>
                    <option value="9">UTC+9 (日本/韩国)</option>
                    <option value="10">UTC+10 (澳大利亚东部)</option>
                    <option value="11">UTC+11</option>
                    <option value="12">UTC+12 (新西兰)</option>
                </select>
            </div>

            <div class="input-section">
                <label class="input-label">出生地点</label>
                <div class="city-search-container">
                    <input type="text" id="birth-city" class="input-field" placeholder="搜索城市..." autocomplete="off">
                    <div id="city-suggestions" class="city-suggestions"></div>
                </div>
                <div class="coords-display">
                    <label>经度: <input type="number" id="birth-lon" step="0.0001" placeholder="116.4074"></label>
                    <label>纬度: <input type="number" id="birth-lat" step="0.0001" placeholder="39.9042"></label>
                </div>
            </div>

            <div class="input-section">
                <label class="input-label">宫位制</label>
                <select id="house-system" class="house-select">
                    <option value="P">Placidus (默认)</option>
                    <option value="K">Koch</option>
                    <option value="W">整宫制 (Whole Sign)</option>
                    <option value="E">等宫制 (Equal)</option>
                    <option value="R">Regiomontanus</option>
                    <option value="C">Campanus</option>
                </select>
            </div>

            <div id="error-container"></div>
        </aside>

        <main class="result-panel">
            <button id="settings-btn" class="settings-btn" title="星盘设置">⚙</button>
            <div id="update-indicator" class="update-indicator" style="display: none;"></div>
            <div id="result-content">
                <div class="result-placeholder">
                    <div class="result-placeholder-icon">&#x2726;</div>
                    <p>正在加载星盘...</p>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="settings-modal">
    <div class="settings-modal-content">
        <div class="settings-modal-header">
            <span class="settings-modal-title">星盘设置</span>
            <button id="settings-close" class="settings-modal-close">&times;</button>
        </div>
        <div class="settings-tabs">
            <button class="settings-tab active" data-tab="planets">天体</button>
            <button class="settings-tab" data-tab="aspects">相位</button>
        </div>
        <div class="settings-body">
            <div id="panel-planets" class="settings-panel active">
                <div class="settings-group">
                    <div class="settings-group-title">主要行星</div>
                    <div class="checkbox-grid" id="main-planets"></div>
                </div>
                <div class="settings-group">
                    <div class="settings-group-title">小行星和特殊点</div>
                    <div class="checkbox-grid" id="minor-planets"></div>
                </div>
            </div>
            <div id="panel-aspects" class="settings-panel">
                <div class="settings-group">
                    <div class="settings-group-title">相位显示与容许度</div>
                    <div id="aspect-settings"></div>
                </div>
                <button id="reset-orbs" class="reset-btn">恢复默认容许度</button>
            </div>
        </div>
        <div class="settings-modal-footer">
            <button id="settings-cancel" class="btn-cancel">取消</button>
            <button id="settings-confirm" class="btn-confirm">确认</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ site.base_path }}/static/js/astrochart2.js"></script>
<script src="{{ site.base_path }}/static/js/astro-sweph.js"></script>
<script>
(function() {
    'use strict';

    // Local cities database for fast search
    const LOCAL_CITIES = [
        { name: '北京', lat: 39.9042, lon: 116.4074 },
        { name: '上海', lat: 31.2304, lon: 121.4737 },
        { name: '广州', lat: 23.1291, lon: 113.2644 },
        { name: '深圳', lat: 22.5431, lon: 114.0579 },
        { name: '成都', lat: 30.5728, lon: 104.0668 },
        { name: '杭州', lat: 30.2741, lon: 120.1551 },
        { name: '武汉', lat: 30.5928, lon: 114.3055 },
        { name: '西安', lat: 34.3416, lon: 108.9398 },
        { name: '南京', lat: 32.0603, lon: 118.7969 },
        { name: '重庆', lat: 29.4316, lon: 106.9123 },
        { name: '天津', lat: 39.0842, lon: 117.2009 },
        { name: '苏州', lat: 31.2990, lon: 120.5853 },
        { name: '郑州', lat: 34.7466, lon: 113.6254 },
        { name: '长沙', lat: 28.2282, lon: 112.9388 },
        { name: '东莞', lat: 23.0207, lon: 113.7518 },
        { name: '沈阳', lat: 41.8057, lon: 123.4315 },
        { name: '青岛', lat: 36.0671, lon: 120.3826 },
        { name: '宁波', lat: 29.8683, lon: 121.5440 },
        { name: '昆明', lat: 25.0389, lon: 102.7183 },
        { name: '大连', lat: 38.9140, lon: 121.6147 },
        { name: '厦门', lat: 24.4798, lon: 118.0894 },
        { name: '福州', lat: 26.0745, lon: 119.2965 },
        { name: '无锡', lat: 31.4912, lon: 120.3119 },
        { name: '合肥', lat: 31.8206, lon: 117.2272 },
        { name: '济南', lat: 36.6512, lon: 117.1201 },
        { name: '哈尔滨', lat: 45.8038, lon: 126.5350 },
        { name: '佛山', lat: 23.0218, lon: 113.1219 },
        { name: '长春', lat: 43.8171, lon: 125.3235 },
        { name: '温州', lat: 28.0000, lon: 120.6667 },
        { name: '石家庄', lat: 38.0428, lon: 114.5149 },
        { name: '南宁', lat: 22.8170, lon: 108.3665 },
        { name: '常州', lat: 31.8108, lon: 119.9741 },
        { name: '泉州', lat: 24.8741, lon: 118.6757 },
        { name: '南昌', lat: 28.6820, lon: 115.8579 },
        { name: '贵阳', lat: 26.6470, lon: 106.6302 },
        { name: '太原', lat: 37.8706, lon: 112.5489 },
        { name: '烟台', lat: 37.4638, lon: 121.4479 },
        { name: '嘉兴', lat: 30.7522, lon: 120.7500 },
        { name: '南通', lat: 31.9829, lon: 120.8943 },
        { name: '金华', lat: 29.0785, lon: 119.6474 },
        { name: '珠海', lat: 22.2710, lon: 113.5767 },
        { name: '惠州', lat: 23.1115, lon: 114.4152 },
        { name: '徐州', lat: 34.2044, lon: 117.2859 },
        { name: '海口', lat: 20.0440, lon: 110.1999 },
        { name: '乌鲁木齐', lat: 43.8256, lon: 87.6168 },
        { name: '绍兴', lat: 30.0000, lon: 120.5833 },
        { name: '中山', lat: 22.5176, lon: 113.3926 },
        { name: '台州', lat: 28.6563, lon: 121.4205 },
        { name: '兰州', lat: 36.0611, lon: 103.8343 },
        { name: '潍坊', lat: 36.7069, lon: 119.1619 },
        { name: '香港', lat: 22.3193, lon: 114.1694 },
        { name: '台北', lat: 25.0330, lon: 121.5654 },
        { name: '澳门', lat: 22.1987, lon: 113.5439 },
        { name: '东京', lat: 35.6762, lon: 139.6503 },
        { name: '首尔', lat: 37.5665, lon: 126.9780 },
        { name: '新加坡', lat: 1.3521, lon: 103.8198 },
        { name: '纽约', lat: 40.7128, lon: -74.0060 },
        { name: '洛杉矶', lat: 34.0522, lon: -118.2437 },
        { name: '伦敦', lat: 51.5074, lon: -0.1278 },
        { name: '巴黎', lat: 48.8566, lon: 2.3522 }
    ];

    // DOM Elements
    const birthYear = document.getElementById('birth-year');
    const birthMonth = document.getElementById('birth-month');
    const birthDay = document.getElementById('birth-day');
    const birthHour = document.getElementById('birth-hour');
    const birthMinute = document.getElementById('birth-minute');
    const timezone = document.getElementById('timezone');
    const birthCity = document.getElementById('birth-city');
    const birthLat = document.getElementById('birth-lat');
    const birthLon = document.getElementById('birth-lon');
    const houseSystem = document.getElementById('house-system');
    const resultContent = document.getElementById('result-content');
    const citySuggestions = document.getElementById('city-suggestions');
    const errorContainer = document.getElementById('error-container');
    const updateIndicator = document.getElementById('update-indicator');
    const mainPlanetsContainer = document.getElementById('main-planets');
    const minorPlanetsContainer = document.getElementById('minor-planets');
    const aspectSettings = document.getElementById('aspect-settings');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const settingsClose = document.getElementById('settings-close');
    const resetOrbsBtn = document.getElementById('reset-orbs');

    // Planet definitions
    const CELESTIAL_BODIES = {
        main: [
            { id: 'Sun', cn: '太阳', symbol: 'Q', default: true },
            { id: 'Moon', cn: '月亮', symbol: 'R', default: true },
            { id: 'Mercury', cn: '水星', symbol: 'S', default: true },
            { id: 'Venus', cn: '金星', symbol: 'T', default: true },
            { id: 'Mars', cn: '火星', symbol: 'U', default: true },
            { id: 'Jupiter', cn: '木星', symbol: 'V', default: true },
            { id: 'Saturn', cn: '土星', symbol: 'W', default: true },
            { id: 'Uranus', cn: '天王星', symbol: 'X', default: true },
            { id: 'Neptune', cn: '海王星', symbol: 'Y', default: true },
            { id: 'Pluto', cn: '冥王星', symbol: 'Z', default: true }
        ],
        minor: [
            { id: 'Chiron', cn: '凯龙星', symbol: 'q', default: false },
            { id: 'Lilith', cn: '莉莉丝', symbol: 'z', default: false },
            { id: 'NNode', cn: '北交点', symbol: '[', default: false },
            { id: 'SNode', cn: '南交点', symbol: ']', default: false }
        ]
    };

    // Aspect definitions
    const ASPECT_DEFS = [
        { id: 'Conjunction', cn: '合相', angle: 0, defaultOrb: 8, default: true },
        { id: 'Opposition', cn: '冲相', angle: 180, defaultOrb: 8, default: true },
        { id: 'Trine', cn: '三分相', angle: 120, defaultOrb: 8, default: true },
        { id: 'Square', cn: '四分相', angle: 90, defaultOrb: 8, default: true },
        { id: 'Sextile', cn: '六分相', angle: 60, defaultOrb: 6, default: true },
        { id: 'Quincunx', cn: '梅花相', angle: 150, defaultOrb: 3, default: false }
    ];

    const SIGNS = ['白羊', '金牛', '双子', '巨蟹', '狮子', '处女', '天秤', '天蝎', '射手', '摩羯', '水瓶', '双鱼'];

    // State
    let selectedPlanets = {};
    let selectedAspects = {};
    let aspectOrbs = {};

    // Backup state for cancel functionality
    let backupPlanets = {};
    let backupAspects = {};
    let backupOrbs = {};

    // Initialize settings modal
    function initSettingsModal() {
        const settingsCancel = document.getElementById('settings-cancel');
        const settingsConfirm = document.getElementById('settings-confirm');

        // Open modal and save backup state
        settingsBtn.addEventListener('click', () => {
            backupPlanets = JSON.parse(JSON.stringify(selectedPlanets));
            backupAspects = JSON.parse(JSON.stringify(selectedAspects));
            backupOrbs = JSON.parse(JSON.stringify(aspectOrbs));
            settingsModal.classList.add('active');
        });

        // Close button (same as cancel)
        settingsClose.addEventListener('click', () => {
            restoreBackupAndClose();
        });

        // Click outside modal (same as cancel)
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                restoreBackupAndClose();
            }
        });

        // Cancel button - restore backup and close
        settingsCancel.addEventListener('click', () => {
            restoreBackupAndClose();
        });

        // Confirm button - save and close
        settingsConfirm.addEventListener('click', () => {
            // Save current state to localStorage
            localStorage.setItem('natal-chart-planets', JSON.stringify(selectedPlanets));
            localStorage.setItem('natal-chart-aspects', JSON.stringify(selectedAspects));
            localStorage.setItem('natal-chart-orbs', JSON.stringify(aspectOrbs));
            settingsModal.classList.remove('active');
            scheduleUpdate();
        });

        // Tab switching
        document.querySelectorAll('.settings-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
            });
        });
    }

    // Restore backup state and close modal
    function restoreBackupAndClose() {
        selectedPlanets = JSON.parse(JSON.stringify(backupPlanets));
        selectedAspects = JSON.parse(JSON.stringify(backupAspects));
        aspectOrbs = JSON.parse(JSON.stringify(backupOrbs));

        // Restore checkbox states
        document.querySelectorAll('[data-planet]').forEach(cb => {
            cb.checked = selectedPlanets[cb.dataset.planet] === true;
        });
        document.querySelectorAll('[data-aspect]').forEach(cb => {
            cb.checked = selectedAspects[cb.dataset.aspect] === true;
        });
        document.querySelectorAll('[data-orb]').forEach(input => {
            input.value = aspectOrbs[input.dataset.orb] || 0;
        });

        settingsModal.classList.remove('active');
    }

    // Initialize planet checkboxes
    function initPlanetCheckboxes() {
        const saved = localStorage.getItem('natal-chart-planets');
        if (saved) {
            try {
                selectedPlanets = JSON.parse(saved);
            } catch (e) {
                selectedPlanets = {};
            }
        }

        // Main planets
        mainPlanetsContainer.innerHTML = CELESTIAL_BODIES.main.map(p => {
            const checked = selectedPlanets[p.id] !== undefined ? selectedPlanets[p.id] : p.default;
            selectedPlanets[p.id] = checked;
            return `
                <label class="checkbox-item">
                    <input type="checkbox" data-planet="${p.id}" ${checked ? 'checked' : ''}>
                    <span class="planet-symbol">${p.symbol}</span>
                    ${p.cn}
                </label>
            `;
        }).join('');

        // Minor planets
        minorPlanetsContainer.innerHTML = CELESTIAL_BODIES.minor.map(p => {
            const checked = selectedPlanets[p.id] !== undefined ? selectedPlanets[p.id] : p.default;
            selectedPlanets[p.id] = checked;
            return `
                <label class="checkbox-item">
                    <input type="checkbox" data-planet="${p.id}" ${checked ? 'checked' : ''}>
                    <span class="planet-symbol">${p.symbol}</span>
                    ${p.cn}
                </label>
            `;
        }).join('');

        // Add event listeners (don't auto-save, wait for confirm)
        document.querySelectorAll('[data-planet]').forEach(cb => {
            cb.addEventListener('change', function() {
                selectedPlanets[this.dataset.planet] = this.checked;
            });
        });
    }

    // Initialize aspect checkboxes
    function initAspectCheckboxes() {
        const savedAspects = localStorage.getItem('natal-chart-aspects');
        const savedOrbs = localStorage.getItem('natal-chart-orbs');

        if (savedAspects) {
            try {
                selectedAspects = JSON.parse(savedAspects);
            } catch (e) {
                selectedAspects = {};
            }
        }

        if (savedOrbs) {
            try {
                aspectOrbs = JSON.parse(savedOrbs);
            } catch (e) {
                aspectOrbs = {};
            }
        }

        aspectSettings.innerHTML = ASPECT_DEFS.map(a => {
            const checked = selectedAspects[a.id] !== undefined ? selectedAspects[a.id] : a.default;
            const orb = aspectOrbs[a.id] !== undefined ? aspectOrbs[a.id] : a.defaultOrb;
            selectedAspects[a.id] = checked;
            aspectOrbs[a.id] = orb;
            return `
                <div class="aspect-row">
                    <div class="aspect-row-left">
                        <input type="checkbox" id="aspect-${a.id}" data-aspect="${a.id}" ${checked ? 'checked' : ''}>
                        <label for="aspect-${a.id}">${a.cn} (${a.angle}°)</label>
                    </div>
                    <div class="aspect-row-right">
                        <span>容许度</span>
                        <input type="number" data-orb="${a.id}" value="${orb}" min="0" max="15" step="0.5">
                        <span>°</span>
                    </div>
                </div>
            `;
        }).join('');

        // Add event listeners (don't auto-save, wait for confirm)
        document.querySelectorAll('[data-aspect]').forEach(cb => {
            cb.addEventListener('change', function() {
                selectedAspects[this.dataset.aspect] = this.checked;
            });
        });

        document.querySelectorAll('[data-orb]').forEach(input => {
            input.addEventListener('change', function() {
                aspectOrbs[this.dataset.orb] = parseFloat(this.value) || 0;
            });
        });

        resetOrbsBtn.addEventListener('click', () => {
            ASPECT_DEFS.forEach(a => {
                aspectOrbs[a.id] = a.defaultOrb;
                const input = document.querySelector(`[data-orb="${a.id}"]`);
                if (input) input.value = a.defaultOrb;
            });
        });
    }

    // Convert local time to UTC based on timezone offset
    function localToUTC(year, month, day, hour, minute, tzOffset) {
        let utcHour = hour - tzOffset;
        let utcDay = day;
        let utcMonth = month;
        let utcYear = year;

        if (utcHour < 0) {
            utcHour += 24;
            utcDay -= 1;
        } else if (utcHour >= 24) {
            utcHour -= 24;
            utcDay += 1;
        }

        const daysInMonth = new Date(utcYear, utcMonth, 0).getDate();
        if (utcDay < 1) {
            utcMonth -= 1;
            if (utcMonth < 1) {
                utcMonth = 12;
                utcYear -= 1;
            }
            utcDay = new Date(utcYear, utcMonth, 0).getDate();
        } else if (utcDay > daysInMonth) {
            utcDay = 1;
            utcMonth += 1;
            if (utcMonth > 12) {
                utcMonth = 1;
                utcYear += 1;
            }
        }

        return { year: utcYear, month: utcMonth, day: utcDay, hour: utcHour, minute };
    }

    // Format timezone for display
    function formatTimezone(offset) {
        const sign = offset >= 0 ? '+' : '';
        if (offset % 1 !== 0) {
            const hours = Math.floor(Math.abs(offset));
            const mins = (Math.abs(offset) % 1) * 60;
            return `UTC${sign}${Math.sign(offset) * hours}:${mins.toString().padStart(2, '0')}`;
        }
        return `UTC${sign}${offset}`;
    }

    // Detect browser timezone offset
    function detectTimezone() {
        const offset = -new Date().getTimezoneOffset() / 60;
        const options = Array.from(timezone.options);
        let closest = options[0];
        let minDiff = Infinity;
        options.forEach(opt => {
            const diff = Math.abs(parseFloat(opt.value) - offset);
            if (diff < minDiff) {
                minDiff = diff;
                closest = opt;
            }
        });
        return closest.value;
    }

    // Fill current date/time
    function fillCurrentDateTime() {
        const now = new Date();
        birthYear.value = now.getFullYear();
        birthMonth.value = now.getMonth() + 1;
        birthDay.value = now.getDate();
        birthHour.value = now.getHours();
        birthMinute.value = now.getMinutes();
        timezone.value = detectTimezone();
    }

    // Get location by IP
    async function getLocationByIP() {
        try {
            const response = await fetch('https://ip-api.com/json/?fields=lat,lon,city,timezone');
            const data = await response.json();
            if (data.lat && data.lon) {
                birthLat.value = data.lat.toFixed(4);
                birthLon.value = data.lon.toFixed(4);
                birthCity.value = data.city || '当前位置';
                return true;
            }
        } catch (e) {
            console.log('IP location failed, using default');
        }
        // Fallback to Beijing
        birthLat.value = '39.9042';
        birthLon.value = '116.4074';
        birthCity.value = '北京';
        return false;
    }

    // City search with local priority
    let searchTimeout;
    birthCity.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 1) {
            citySuggestions.classList.remove('active');
            return;
        }

        // First try local search (instant)
        const localResults = LOCAL_CITIES.filter(c =>
            c.name.toLowerCase().includes(query.toLowerCase())
        ).slice(0, 5);

        if (localResults.length > 0) {
            showCitySuggestions(localResults.map(c => ({
                name: c.name,
                detail: `${c.lat.toFixed(4)}°, ${c.lon.toFixed(4)}°`,
                lat: c.lat,
                lon: c.lon
            })));
            return;
        }

        // Fallback to API with debounce
        searchTimeout = setTimeout(() => searchCityAPI(query), 200);
    });

    function showCitySuggestions(results) {
        if (results.length === 0) {
            citySuggestions.innerHTML = '<div class="city-suggestion"><div class="city-suggestion-name">未找到结果</div></div>';
        } else {
            citySuggestions.innerHTML = results.map(r => `
                <div class="city-suggestion" data-lat="${r.lat}" data-lon="${r.lon}" data-name="${r.name}">
                    <div class="city-suggestion-name">${r.name}</div>
                    <div class="city-suggestion-detail">${r.detail}</div>
                </div>
            `).join('');
        }
        citySuggestions.classList.add('active');
    }

    async function searchCityAPI(query) {
        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&addressdetails=1`,
                { headers: { 'Accept-Language': 'zh,en' } }
            );
            const results = await response.json();

            showCitySuggestions(results.map(r => ({
                name: r.display_name.split(',')[0],
                detail: r.display_name,
                lat: parseFloat(r.lat),
                lon: parseFloat(r.lon)
            })));
        } catch (error) {
            console.error('City search error:', error);
        }
    }

    citySuggestions.addEventListener('click', function(e) {
        const suggestion = e.target.closest('.city-suggestion');
        if (suggestion && suggestion.dataset.lat) {
            birthCity.value = suggestion.dataset.name;
            birthLat.value = parseFloat(suggestion.dataset.lat).toFixed(4);
            birthLon.value = parseFloat(suggestion.dataset.lon).toFixed(4);
            citySuggestions.classList.remove('active');
            saveData();
            scheduleUpdate();
        }
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.city-search-container')) {
            citySuggestions.classList.remove('active');
        }
    });

    // Coordinate input handlers
    birthLat.addEventListener('change', () => {
        saveData();
        scheduleUpdate();
    });

    birthLon.addEventListener('change', () => {
        saveData();
        scheduleUpdate();
    });

    // Debounced chart update
    let updateTimeout;
    function scheduleUpdate() {
        clearTimeout(updateTimeout);
        updateIndicator.style.display = 'block';
        updateTimeout = setTimeout(() => {
            generateChart();
            updateIndicator.style.display = 'none';
        }, 500);
    }

    // Generate chart
    async function generateChart() {
        const year = parseInt(birthYear.value);
        const month = parseInt(birthMonth.value);
        const day = parseInt(birthDay.value);
        const hour = parseInt(birthHour.value) || 12;
        const minute = parseInt(birthMinute.value) || 0;
        const lat = parseFloat(birthLat.value);
        const lon = parseFloat(birthLon.value);
        const tzOffset = parseFloat(timezone.value);

        if (!year || !month || !day) {
            return;
        }

        if (isNaN(lat) || isNaN(lon)) {
            return;
        }

        clearError();

        try {
            if (typeof Module === 'undefined' || !Module._get) {
                resultContent.innerHTML = `
                    <div class="result-placeholder">
                        <div class="result-placeholder-icon">&#x2726;</div>
                        <p>星历计算模块加载中...</p>
                    </div>
                `;
                return;
            }

            const utc = localToUTC(year, month, day, hour, minute, tzOffset);

            const lonDeg = Math.floor(Math.abs(lon));
            const lonMin = Math.floor((Math.abs(lon) - lonDeg) * 60);
            const lonSec = Math.round(((Math.abs(lon) - lonDeg) * 60 - lonMin) * 60);
            const lonDir = lon >= 0 ? 'E' : 'W';

            const latDeg = Math.floor(Math.abs(lat));
            const latMin = Math.floor((Math.abs(lat) - latDeg) * 60);
            const latSec = Math.round(((Math.abs(lat) - latDeg) * 60 - latMin) * 60);
            const latDir = lat >= 0 ? 'N' : 'S';

            const hsys = houseSystem.value;

            const resultPtr = Module._get(
                utc.year, utc.month, utc.day, utc.hour, utc.minute, 0,
                lonDeg, lonMin, lonSec, lonDir,
                latDeg, latMin, latSec, latDir,
                hsys
            );

            const resultStr = Module.UTF8ToString(resultPtr);
            const chartData = JSON.parse(resultStr);

            if (chartData.error) {
                throw new Error(chartData.error_msg || '计算错误');
            }

            renderChart(chartData, {
                local: { year, month, day, hour, minute },
                utc: utc,
                timezone: tzOffset
            });

        } catch (error) {
            console.error('Chart generation error:', error);
            showError(error.message || '生成星盘时发生错误');
        }
    }

    function renderChart(data, birthInfo) {
        let planetsData = data.planets || data.body || data.bodies || [];
        let housesData = data.house || data.houses || data.cusps || [];

        if (!Array.isArray(planetsData) || planetsData.length === 0) {
            throw new Error('未找到行星数据');
        }

        // Name mapping from Swiss Ephemeris to our IDs
        const NAME_MAP = {
            'Mean Node': 'NNode',
            'True Node': 'NNode',
            'mean Node': 'NNode',
            'North Node': 'NNode',
            'Mean Apogee': 'Lilith',
            'mean Apogee': 'Lilith',
            'Black Moon': 'Lilith'
        };

        // Map planet names and add South Node
        const mappedPlanets = [];
        planetsData.forEach(p => {
            const mappedName = NAME_MAP[p.name] || p.name;
            mappedPlanets.push({ ...p, name: mappedName });

            if (mappedName === 'NNode') {
                const lon = p.lon !== undefined ? p.lon : p.long;
                mappedPlanets.push({
                    name: 'SNode',
                    lon: (lon + 180) % 360,
                    speed: p.speed
                });
            }
        });

        // Get list of enabled planet IDs
        const enabledPlanetIds = Object.keys(selectedPlanets).filter(id => selectedPlanets[id] === true);

        // Filter planets based on selection
        const filteredPlanets = mappedPlanets.filter(p => enabledPlanetIds.includes(p.name));

        const points = filteredPlanets.map(p => ({
            name: p.name,
            angle: p.lon !== undefined ? p.lon : p.long,
            isRetrograde: p.speed < 0
        }));

        const cusps = housesData.map(c => ({ angle: c.lon !== undefined ? c.lon : c.long }));

        const localTimeStr = `${birthInfo.local.year}年${birthInfo.local.month}月${birthInfo.local.day}日 ${String(birthInfo.local.hour).padStart(2, '0')}:${String(birthInfo.local.minute).padStart(2, '0')}`;
        const utcTimeStr = `${birthInfo.utc.year}年${birthInfo.utc.month}月${birthInfo.utc.day}日 ${String(birthInfo.utc.hour).padStart(2, '0')}:${String(birthInfo.utc.minute).padStart(2, '0')}`;
        const tzStr = formatTimezone(birthInfo.timezone);

        resultContent.innerHTML = `
            <div class="time-info" style="text-align: center; margin-bottom: 20px; padding: 16px; background: var(--natal-bg); border-radius: 8px; font-size: 14px;">
                <div style="margin-bottom: 8px;"><strong>本地时间:</strong> ${localTimeStr} (${tzStr})</div>
                <div style="color: var(--natal-text-secondary);"><strong>UTC时间:</strong> ${utcTimeStr}</div>
            </div>
            <div id="natal-chart"></div>
            <div class="info-tables">
                <div class="info-table">
                    <div class="info-table-title">行星位置</div>
                    <table>
                        <thead>
                            <tr>
                                <th>天体</th>
                                <th>星座</th>
                                <th>度数</th>
                                <th>宫位</th>
                            </tr>
                        </thead>
                        <tbody id="planets-table"></tbody>
                    </table>
                </div>
                <div class="info-table">
                    <div class="info-table-title">宫头位置</div>
                    <table>
                        <thead>
                            <tr>
                                <th>宫位</th>
                                <th>星座</th>
                                <th>度数</th>
                            </tr>
                        </thead>
                        <tbody id="houses-table"></tbody>
                    </table>
                </div>
            </div>
        `;

        // Build aspects array from settings
        const enabledAspectIds = Object.keys(selectedAspects).filter(id => selectedAspects[id] === true);
        const ASPECTS = ASPECT_DEFS
            .filter(a => enabledAspectIds.includes(a.id))
            .map(a => ({
                name: a.id,
                angle: a.angle,
                orb: aspectOrbs[a.id] !== undefined ? aspectOrbs[a.id] : a.defaultOrb
            }));

        try {
            const chartContainer = document.getElementById('natal-chart');
            if (chartContainer) {
                chartContainer.innerHTML = '';
            }
            const chart = new astrology.Universe('natal-chart');
            chart.radix().setData({ points, cusps });
            chart.radix().drawAspects(points, points, ASPECTS);
        } catch (e) {
            console.error('Chart render error:', e);
        }

        const planetsTable = document.getElementById('planets-table');
        planetsTable.innerHTML = filteredPlanets.map(p => {
            const pLong = p.lon !== undefined ? p.lon : p.long;
            const signIndex = Math.floor(pLong / 30);
            const degInSign = pLong % 30;
            const deg = Math.floor(degInSign);
            const min = Math.floor((degInSign - deg) * 60);
            const house = getHouse(pLong, housesData);
            const retrograde = p.speed < 0 ? '<span class="retrograde">R</span>' : '';

            return `
                <tr>
                    <td><span class="planet-symbol">${getPlanetSymbol(p.name)}</span> ${getPlanetCN(p.name)}${retrograde}</td>
                    <td>${SIGNS[signIndex]}</td>
                    <td>${deg}°${min}'</td>
                    <td>${house}宫</td>
                </tr>
            `;
        }).join('');

        const housesTable = document.getElementById('houses-table');
        housesTable.innerHTML = housesData.map((c, i) => {
            const cLong = c.lon !== undefined ? c.lon : c.long;
            const signIndex = Math.floor(cLong / 30);
            const degInSign = cLong % 30;
            const deg = Math.floor(degInSign);
            const min = Math.floor((degInSign - deg) * 60);
            const houseNames = ['', 'ASC', '', '', 'IC', '', '', 'DSC', '', '', 'MC', '', ''];
            const label = houseNames[i + 1] ? ` (${houseNames[i + 1]})` : '';

            return `
                <tr>
                    <td>${i + 1}宫${label}</td>
                    <td>${SIGNS[signIndex]}</td>
                    <td>${deg}°${min}'</td>
                </tr>
            `;
        }).join('');
    }

    function getHouse(planetLong, cusps) {
        for (let i = 0; i < 12; i++) {
            const nextI = (i + 1) % 12;
            const c = cusps[i];
            const nc = cusps[nextI];
            let start = c.lon !== undefined ? c.lon : c.long;
            let end = nc.lon !== undefined ? nc.lon : nc.long;

            if (end < start) end += 360;
            let pLong = planetLong;
            if (pLong < start) pLong += 360;

            if (pLong >= start && pLong < end) {
                return i + 1;
            }
        }
        return 1;
    }

    function getPlanetSymbol(name) {
        const all = [...CELESTIAL_BODIES.main, ...CELESTIAL_BODIES.minor];
        const found = all.find(p => p.id === name);
        return found ? found.symbol : '';
    }

    function getPlanetCN(name) {
        const all = [...CELESTIAL_BODIES.main, ...CELESTIAL_BODIES.minor];
        const found = all.find(p => p.id === name);
        return found ? found.cn : name;
    }

    function showError(message) {
        errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
    }

    function clearError() {
        errorContainer.innerHTML = '';
    }

    // Load saved data from localStorage
    function loadSavedData() {
        const saved = localStorage.getItem('natal-chart-input');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                if (data.year) birthYear.value = data.year;
                if (data.month) birthMonth.value = data.month;
                if (data.day) birthDay.value = data.day;
                if (data.hour) birthHour.value = data.hour;
                if (data.minute) birthMinute.value = data.minute;
                if (data.timezone !== undefined) timezone.value = data.timezone;
                if (data.city) birthCity.value = data.city;
                if (data.lat) birthLat.value = data.lat;
                if (data.lon) birthLon.value = data.lon;
                return true;
            } catch (e) {}
        }
        return false;
    }

    // Save data on input change
    function saveData() {
        const data = {
            year: birthYear.value,
            month: birthMonth.value,
            day: birthDay.value,
            hour: birthHour.value,
            minute: birthMinute.value,
            timezone: timezone.value,
            city: birthCity.value,
            lat: birthLat.value,
            lon: birthLon.value
        };
        localStorage.setItem('natal-chart-input', JSON.stringify(data));
    }

    // Add input event listeners for real-time updates
    [birthYear, birthMonth, birthDay, birthHour, birthMinute, timezone, houseSystem].forEach(el => {
        el.addEventListener('input', () => {
            saveData();
            scheduleUpdate();
        });
        el.addEventListener('change', () => {
            saveData();
            scheduleUpdate();
        });
    });

    // Initialize
    async function init() {
        initSettingsModal();
        initPlanetCheckboxes();
        initAspectCheckboxes();

        const hasSavedData = loadSavedData();

        if (!hasSavedData) {
            fillCurrentDateTime();
            await getLocationByIP();
        }

        // Wait for WASM module to load, then generate chart
        const checkModule = setInterval(() => {
            if (typeof Module !== 'undefined' && Module._get) {
                clearInterval(checkModule);
                generateChart();
            }
        }, 100);

        // Timeout after 10 seconds
        setTimeout(() => clearInterval(checkModule), 10000);
    }

    init();
})();
</script>
{% endblock %}
